<%-- 
    Document   : checkNow
    Created on : 30-ene-2011, 23:49:44
    Author     : tote
--%>

<%@page import="java.net.URLDecoder"%>
<%@page import="es.uah.cc.ie.sources.settingsFilter"%>
<%@page import="java.util.Date"%>
<%@page import="es.uah.cc.ie.sources.SNSdataBaseIntegrator"%>
<%@page contentType="text/html" pageEncoding="UTF-8"%>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">

<%
            //Obtenemos la conexión a Facebook
            SNSdataBaseIntegrator snsDB = SNSdataBaseIntegrator.getSessionInstance(request);
            snsDB.getLoginFacebook(request, response);
            HttpSession sesion = request.getSession(false);
            System.out.println("CHECKNOW: OBJETO ID: " + snsDB.getUserSettings().getUid());
            System.out.println("CHECKNOW: NUEVA CONEXION: " + snsDB.isNewConnection());

            System.out.println("CHECKNOW: CHECK FRIEND: " + sesion.getAttribute("hdAngels"));
            System.out.println("CHECKNOW: ANGELS GOOGLE: " + request.getParameter("hdAngelsGoogleSelected"));
            System.out.println("CHECKNOW: ANGELS ED: " + request.getParameter("hdAngelsEd"));
            System.out.println("CHECKNOW: LIST FLT WALL: " + request.getParameter("hdLstAngelsFltWall"));
            System.out.println("CHECKNOW: LIST FLT FRIENDS: " + request.getParameter("hdLstAngelsFltFriends"));
            System.out.println("CHECKNOW: LIST FLT PRIVACI: " + request.getParameter("hdLstAngelsFltPriv"));
            System.out.println("CHECKNOW: LIST FLT VISITAS: " + request.getParameter("hdLstAngelsFltVist"));
            System.out.println("CHECKNOW: FLT WALL ACTIVE: " + request.getParameter("hdActiveFltWall"));
            System.out.println("CHECKNOW: FLT FRND ACTIVE: " + request.getParameter("hdActiveFltFriends"));
            System.out.println("CHECKNOW: FLT PRIV ACTIVE: " + request.getParameter("hdActiveFltPriv"));
            System.out.println("CHECKNOW: FLT VIST ACTIVE: " + request.getParameter("hdActiveFltVist"));
            System.out.println("CHECKNOW: FLT WALL FREC: " + request.getParameter("hdFrecFltWall"));
            System.out.println("CHECKNOW: FLT FRND FREC: " + request.getParameter("hdFrecFltFriends"));
            System.out.println("CHECKNOW: FLT PRIV FREC: " + request.getParameter("hdFrecFltPriv"));
            System.out.println("CHECKNOW: FLT VIST FREC: " + request.getParameter("hdFrecFltVist"));

            String hdAngels = request.getParameter("hdAngels");
            String hdAngelsGoogleSelected = request.getParameter("hdAngelsGoogleSelected");
            String hdAngelsEd = request.getParameter("hdAngelsEd");
            String hdLstAngelsFltWall = request.getParameter("hdLstAngelsFltWall");
            String hdLstAngelsFltFriends = request.getParameter("hdLstAngelsFltFriends");
            String hdLstAngelsFltPriv = request.getParameter("hdLstAngelsFltPriv");
            String hdLstAngelsFltVist = request.getParameter("hdLstAngelsFltVist");
            String hdActiveFltWall = request.getParameter("hdActiveFltWall");
            String hdActiveFltFriends = request.getParameter("hdActiveFltFriends");
            String hdActiveFltPriv = request.getParameter("hdActiveFltPriv");
            String hdActiveFltVist = request.getParameter("hdActiveFltVist");
            String hdFrecFltWall = request.getParameter("hdFrecFltWall");
            String hdFrecFltFriends = request.getParameter("hdFrecFltFriends");
            String hdFrecFltPriv = request.getParameter("hdFrecFltPriv");
            String hdFrecFltVist= request.getParameter("hdFrecFltVist");

            if (snsDB.isNewConnection()) {
                System.out.println("NUEVA CONEXION");
                settingsFilter fltWall = new settingsFilter(snsDB.getUserSettings().getUid(), hdFrecFltWall, hdLstAngelsFltWall, hdActiveFltWall, snsDB.getUserSettings().getUid(), new Date());
                snsDB.getUserSettings().setFltWall(fltWall);

                settingsFilter fltFriends = new settingsFilter(snsDB.getUserSettings().getUid(), hdFrecFltFriends, hdLstAngelsFltFriends, hdActiveFltFriends, snsDB.getUserSettings().getUid(), new Date());
                snsDB.getUserSettings().setFltFriends(fltFriends);

                settingsFilter fltPriv = new settingsFilter(snsDB.getUserSettings().getUid(), hdFrecFltPriv, hdLstAngelsFltPriv, hdActiveFltPriv, snsDB.getUserSettings().getUid(), new Date());
                snsDB.getUserSettings().setFltPriv(fltPriv);

                settingsFilter fltVist = new settingsFilter(snsDB.getUserSettings().getUid(), hdFrecFltVist, hdLstAngelsFltVist, hdActiveFltVist, snsDB.getUserSettings().getUid(), new Date());
                snsDB.getUserSettings().setFltVist(fltVist);

                snsDB.getUserSettings().setAppActivated(true);
                snsDB.getUserSettings().setLegalAccepted(true);
                snsDB.getUserSettings().setLastCheck(new Date());
                snsDB.getUserSettings().setBackupCheck(new Date());

                snsDB.putNewInstanceUS(request,response);
                snsDB.getUserInfo(true);
                System.out.println("FIN NUEVA CONEXION");
                // Enviamos correo de confirmacion a los Angeles
                snsDB.sendMailConfirmation();
            } else {
                System.out.println("NO NUEVA CONEXION");
                settingsFilter fltWall = new settingsFilter(snsDB.getUserSettings().getUid(), hdFrecFltWall, hdLstAngelsFltWall, hdActiveFltWall, snsDB.getUserSettings().getUid(), new Date());
                snsDB.getUserSettings().setFltWall(fltWall);
                settingsFilter fltFriends = new settingsFilter(snsDB.getUserSettings().getUid(), hdFrecFltFriends, hdLstAngelsFltFriends, hdActiveFltFriends, snsDB.getUserSettings().getUid(), new Date());
                snsDB.getUserSettings().setFltFriends(fltFriends);
                settingsFilter fltPriv = new settingsFilter(snsDB.getUserSettings().getUid(), hdFrecFltPriv, hdLstAngelsFltPriv, hdActiveFltPriv, snsDB.getUserSettings().getUid(), new Date());
                snsDB.getUserSettings().setFltPriv(fltPriv);
                settingsFilter fltVist = new settingsFilter(snsDB.getUserSettings().getUid(), hdFrecFltVist, hdLstAngelsFltVist, hdActiveFltVist, snsDB.getUserSettings().getUid(), new Date());
                snsDB.getUserSettings().setFltVist(fltVist);
                snsDB.updateLastCheckUS();
                snsDB.getUserSettings().setAngelsUserSettings();
                snsDB.getUserInfo(false);
                System.out.println("FIN NO NUEVA CONEXION");
            }

            // Cerramos la conexión con la Base de Datos
            //snsDB.cerrarConexionSNS();
            
            // Volvemos a la pagina de configuración
            response.sendRedirect(request.getContextPath() + "/settingsSNSAngelGuard.jsp?newConection=1&ok=1");
%>