/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package es.uah.cc.ie.sources;

import com.mysql.jdbc.exceptions.jdbc4.MySQLIntegrityConstraintViolationException;
import com.sun.jersey.api.client.UniformInterfaceException;
import es.uah.cc.ie.FacebookClient.FacebookClient;
import es.uah.cc.ie.SNSWebServicesClient.SNSdataBaseClient;
import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.UnsupportedEncodingException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import javax.mail.MessagingException;
import javax.mail.NoSuchProviderException;
import javax.servlet.http.*;
import javax.servlet.http.HttpServletResponse;
import org.apache.log4j.Logger;
import org.bouncycastle.crypto.DataLengthException;
import org.bouncycastle.crypto.InvalidCipherTextException;
import org.codehaus.jettison.json.JSONArray;
import org.codehaus.jettison.json.JSONException;
import org.codehaus.jettison.json.JSONObject;
import org.openide.util.Exceptions;
import java.io.IOException;
import java.net.URL;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.util.Calendar;

/**
 *
 * @author tote
 */
public final class SNSdataBaseIntegrator {

    private boolean permAcep = false;
    private boolean newConnection = false;
    private UserSettings userSettings = new UserSettings();
    private LocaleSettings localeSettings = null;
    private static Logger logger = Logger.getLogger(SNSdataBaseIntegrator.class);
    private String[][] arrayAngels = null;
    private String[][] arrayAngelsSelected = null;
    private boolean inicio = true;
    private String context = "http://oe.dynalias.net:8080/";

    public boolean isPermAcep() {
        return permAcep;
    }

    public void setPermAcep(boolean permAcep) {
        this.permAcep = permAcep;
    }

    public boolean isNewConnection() {
        return newConnection;
    }

    public void setNewConnection(boolean newConnection) {
        this.newConnection = newConnection;
    }

    public UserSettings getUserSettings() {
        return userSettings;
    }

    public void setUserSettings(UserSettings userSettings) {
        this.userSettings = userSettings;
    }

    public LocaleSettings getLocaleSettings() {
        return localeSettings;
    }

    public void setLocaleSettings(LocaleSettings localeSettings) {
        this.localeSettings = localeSettings;
    }

    public static Logger getLogger() {
        return logger;
    }

    public static void setLogger(Logger aLogger) {
        logger = aLogger;
    }

    public String[][] getArrayAngels() {
        return arrayAngels;
    }

    public void setArrayAngels(String[][] arrayAngels) {
        this.arrayAngels = arrayAngels;
    }

    public String[][] getArrayAngelsSelected() {
        return arrayAngelsSelected;
    }

    public void setArrayAngelsSelected(String[][] arrayAngelsSelected) {
        this.arrayAngelsSelected = arrayAngelsSelected;
    }

    public boolean isInicio() {
        return inicio;
    }

    public void setInicio(boolean inicio) {
        this.inicio = inicio;
    }

    public String getContext() {
        return context;
    }

    public void setContext(String context) {
        this.context = context;
    }
    private static SNSdataBaseClient client = new SNSdataBaseClient();
    private static FacebookClient facebookClient = new FacebookClient();
    private static emailObject email = new emailObject();

    /**
     * @return the client
     */
    public static SNSdataBaseClient getClient() {
        return client;
    }

    /**
     * @param aClient the client to set
     */
    public static void setClient(SNSdataBaseClient aClient) {
        client = aClient;
    }

    //Obtenemos la sesion
    public static SNSdataBaseIntegrator getSessionInstance(HttpServletRequest request) {

        SNSdataBaseIntegrator instance = (SNSdataBaseIntegrator) request.getSession().getAttribute("snsangelguardfb");

        if (instance == null) {
            instance = new SNSdataBaseIntegrator();
            request.getSession().setAttribute("snsangelguardfb", instance);
            escribeInicioFin("INICIO", request.getSession().toString());
        }
        return instance;
    }

    public static void escribeInicioFin(String modo, String Sesion) {
        if (modo.equals("INICIO")) {
            getLogger().info("START PROGRAM " + Sesion);
        } else if (modo.equals("FIN")) {
            getLogger().info("FINISH PROGRAM UID: " + Sesion);
        }
    }

    public String getLoginPermision(HttpServletRequest request) throws IOException {
        HttpSession session = request.getSession(false);
        getLogger().info(getUserSettings().getUid() + ": UID LOGIN: " + getUserSettings().getUid());
        getLogger().info(getUserSettings().getUid() + ": GETTING PERMISSIONS ...");
        String permiso = getPermisosApp(request);
        getLogger().info(getUserSettings().getUid() + ": GIVEN PERMISSIONS: " + permiso);
        session.setAttribute("users_hasAppPermission", permiso);
        session.setAttribute("users_AppPermissionDisabled", isPermisosAppDisabled(permiso));
        return permiso;

    }

    public String getPermisosApp(HttpServletRequest request) throws IOException, UniformInterfaceException {
        HttpSession session = request.getSession(false);
        String[] permiso = new String[14];
        permiso[0] = execFbInst(1);
        permiso[1] = execFbInst(2);
        permiso[2] = execFbInst(3);
        permiso[3] = execFbInst(4);
        permiso[4] = execFbInst(5);
        permiso[5] = execFbInst(6);
        permiso[6] = execFbInst(7);
        permiso[7] = execFbInst(8);
        permiso[8] = execFbInst(9);
        permiso[9] = execFbInst(10);
        permiso[10] = execFbInst(11);
        permiso[11] = execFbInst(12);
        permiso[12] = execFbInst(13);
        permiso[13] = execFbInst(14);

        //System.out.println("DENTRO PERMISO");

        String app = "";

        for (int i = 0; i < 14; i++) {
            if (i == 13) {
                app += permiso[i];
            } else {
                app += permiso[i] + ",";
            }
        }
        return app;
    }

    public String isPermisosAppDisabled(String permisos) {
        String[] permiso = permisos.split(",");
        int longitud = permiso.length;
        for (int i = 0; i < longitud; i++) {
            if (permiso[i].equals("0")) {
                getLogger().info(getUserSettings().getUid() + ": DISABLED PERMISSION: " + i);
                return "0";
            }
        }
        // Código de retorno en caso de que todos los permisos estén habilitados
        return "200";
    }

    //Obtenemos la conexion en Facebook
    public void getLoginFacebook(HttpServletRequest request, HttpServletResponse response) throws IOException, JSONException {
        HttpSession session = request.getSession(false);
        String login = "";
        System.out.println("GTLGFACE: SESION FACEBOOK: " + facebookClient.getSessionKeyFacebook());
        System.out.println("GTLGFACE: LISTA DE ANGELES: " + request.getParameter("hdAngels"));
        getLogger().info(getUserSettings().getUid() + ": SESSION KEY LOGIN 1: " + session.getAttribute("facebook_session_key"));
        if (session.getAttribute("facebook_session_key") != null) {
            getLogger().info(getUserSettings().getUid() + ": SESSION KEY LOGIN 2: " + session.getAttribute("facebook_session_key"));
            System.out.println("GTLGFACE: SESION DISTINTA DE NULL");
            getLogger().info(getUserSettings().getUid() + ": SESSION KEY LOGIN: " + session.getAttribute("facebook_session_key"));
            getUserSettings().setUserSession((String) session.getAttribute("facebook_session_key"));
            this.updateUserID(request, response);
            String permisos = getLoginPermision(request);
            if (isPermisosAppDisabled(permisos).equals("0")) {
                this.setPermAcep(false);
                getLogger().info(getUserSettings().getUid() + ": REDIRECTING TO ACCEPT PERMISS ");
                facebookClient.obtenerPermisosUsuario(request, response, getUserSettings().getUid());
            } else {
                this.setPermAcep(true);
                getLogger().info(getUserSettings().getUid() + ": DON'T REDIRECT...");
            }
        } else {
            getLogger().info(getUserSettings().getUid() + ": SESSION KEY LOGIN 3: " + session.getAttribute("facebook_session_key"));
            facebookClient.login(request, response, "b48d8cbb1add1cbca8cc3e0e48f4728c", "bb076f1a08faaedf2cf8f75f22fe6a57");
        }
    }

    public void logSession(HttpServletRequest request, HttpServletResponse response) throws IOException, JSONException {
        HttpSession session = request.getSession(false);
        System.out.println("LOGSESIN: SESION FACEBOOK: " + facebookClient.getSessionKeyFacebook());
        if (session.getAttribute("facebook_session_key") != null) {
            getLogger().info(getUserSettings().getUid() + ": LOGSESIN SESSION KEY LOGIN 2: " + session.getAttribute("facebook_session_key"));
            System.out.println("LOGSESIN: SESION DISTINTA DE NULL");
            getLogger().info(getUserSettings().getUid() + ": LOGSESIN SESSION KEY LOGIN: " + session.getAttribute("facebook_session_key"));
            getUserSettings().setUserSession((String) session.getAttribute("facebook_session_key"));
            this.updateUserID(request, response);
        } else {
            facebookClient.login(request, response, "b48d8cbb1add1cbca8cc3e0e48f4728c", "bb076f1a08faaedf2cf8f75f22fe6a57");
        }
    }

    //Funciones de manejo de la base de datos
    /**
     * Gets user ID of the current user logged in.
     * @param request
     * @param response
     */
    public void updateUserID(HttpServletRequest request, HttpServletResponse response) throws UniformInterfaceException, IOException {
        HttpSession session = request.getSession(false);
        String format = "";

        try {
            for (int j = 0; j < 10; j++) {
                format = facebookClient.users_getLoggedInUser(String.class, request, "format=json");

                if (!format.contains("error_code") && !format.contains("{}")) {
                    break;
                } else if (j == 9) {
                    getLogger().error(getUserSettings().getUid() + ": UID FORMAT DON'T ACCEPTED");
                }
            }
            try {
                if (Double.parseDouble(format) > 0) {
                    getUserSettings().setUid(format);
                    getLogger().info(getUserSettings().getUid() + ": UID ACCEPTED: " + format);
                }
            } catch (Exception e) {
                getLogger().error(getUserSettings().getUid() + ": UID FORMAT DON'T ACCEPTED");
                getUserSettings().setUid(null);
            }

        } catch (Exception ex) {
            getLogger().fatal(getUserSettings().getUid() + ": ERROR CREATING UID");
            getLogger().fatal(getUserSettings().getUid() + ": " + ex);
        }
    }

    public void getUserInfoSimple() throws JSONException, ParseException {
        JSONObject jsonUserInfo = null;

        try {
            jsonUserInfo = getClient().userSettings_getUserSettingsById(JSONObject.class, getUserSettings().getUid());
            getLogger().info(getUserSettings().getUid() + ": USER DATES : " + jsonUserInfo.toString());
        } catch (Exception e) {
            getLogger().info(getUserSettings().getUid() + ": NO EXISTING USER IN DATA BASE");
        }

        this.setUserSettings(loadUser(jsonUserInfo));
        this.setNewConnection(false);
    }

    /**
     * Loads the user settings from the database. Then, stores them in their correspondant attributes.
     */
    public void loadSettings() throws ParseException, JSONException {

        if (getUserSettings().getUid() == null) {
            getLogger().error(getUserSettings().getUid() + ": UID FORMAT DON'T ACCEPTED");
            return;
        }

        JSONObject jsonObject = new JSONObject();

        // Aqui deberá ir un servicio web para obtener los datos de nuesta BBDD
        // correspondientes al usuario
        try {
            jsonObject = getClient().userSettings_getUserSettingsById(JSONObject.class, getUserSettings().getUid());
            getLogger().info(getUserSettings().getUid() + ": USER DATES : " + jsonObject.toString());
            this.setNewConnection(false);
        } catch (Exception e) {
            getLogger().info(getUserSettings().getUid() + ": NO EXISTING USER IN DATA BASE");
            this.setNewConnection(true);
        }

        if (this.isNewConnection()) {
            setNewUserConnected();
            userSettings.setLegalAccepted(false);
        } else {
            try {
                loadUserConnected(jsonObject);
            } catch (JSONException ex) {
                getLogger().fatal(getUserSettings().getUid() + ": ERROR IN SOCIAL NETWORK DATES FROM USER");
                getLogger().fatal(getUserSettings().getUid() + ": " + ex);
            }
        }
        loadLocaleSettings();
    }

    public Date formatTime(String strTime) throws ParseException {
        Date time = new Date();
        SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd HH:mm:ss");
        time = sdf.parse(strTime);
        return time;
    }

    public UserSettings loadUser(JSONObject user) throws JSONException, ParseException {

        return new UserSettings(user.getString("uid"), user.getString("userName"),
                user.getString("userEmail"), user.getString("legalAccepted").equals("1"), formatTime(user.getString("lastCheck").replace("T", " ")),
                user.getString("uidPublic"), user.getString("appActivated").equals("1"),
                user.getString("userSession"), formatTime(user.getString("backupCheck").replace("T", " ")), getClient());
    }

    public void loadUserConnected(JSONObject settings) throws JSONException, ParseException {
        System.out.println("DATOS OBTENIDOS DE LA BBDD: " + settings.toString());
        this.setUserSettings(loadUser(settings));

        getLogger().info(getUserSettings().getUid() + ": USER CONECTED UID: " + getUserSettings().getUid());
        getLogger().info(getUserSettings().getUid() + ": USER CONECTED EMAIL: " + getUserSettings().getUserEmail());
        getLogger().info(getUserSettings().getUid() + ": USER CONECTED NAME: " + getUserSettings().getUserName());
        getLogger().info(getUserSettings().getUid() + ": USER CONECTED LEGAL ACCEPTED: " + getUserSettings().isLegalAccepted());
        getLogger().info(getUserSettings().getUid() + ": USER CONECTED APP ACTIVATED: " + getUserSettings().isAppActivated());
        getLogger().info(getUserSettings().getUid() + ": USER CONECTED LAST CHECK: " + getUserSettings().getLastCheck().getTime() / 1000);
        getLogger().info(getUserSettings().getUid() + ": USER CONECTED LOCALE SETTINGS: " + getUserSettings().getLocaleSettings());
        getLogger().info(getUserSettings().getUid() + ": USER CONECTED SESSION FACEBOOK: " + getUserSettings().getUserSession());

        this.setNewConnection(false);

    }

    public void setNewUserConnected() throws ParseException {

        JSONObject jsonUserSettings = null;
        String appInfo = "";

        try {
            String userInfo = "";
            for (int i = 0; i < 10; i++) {
                getLogger().info(getUserSettings().getUid() + ": TRYING TO OBTAIN NEW USER INFORMATION " + (i + 1));
                userInfo = execFbInst(16);

                if (!userInfo.equals("null") && !userInfo.contains("error_code")) {
                    getLogger().error(getUserSettings().getUid() + ": ERROR TO OBTAIN NEW USER INFORMATION");
                    break;
                }
            }


            userInfo = userInfo.replace("[", "");
            userInfo = userInfo.replace("]", "");

            try {
                appInfo = execFbInst(20);
                System.out.println("APP INFO: " + appInfo);
                System.out.println("INFORMACION USUARIO: " + userInfo);
                jsonUserSettings = new JSONObject(userInfo);
                getLogger().info(getUserSettings().getUid() + ": NEW USER INFORMATION: " + jsonUserSettings.toString());

                userSettings = new UserSettings((String) jsonUserSettings.getString("uid"),
                        (String) jsonUserSettings.getString("name"),
                        (String) jsonUserSettings.getString("uid"), this.getClient(), this);

            } catch (JSONException ex) {
                getLogger().error(getUserSettings().getUid() + ": ERROR TO OBTAIN NEW USER INFORMATION");
                ex.printStackTrace();
            }
        } catch (UniformInterfaceException ex) {
            Exceptions.printStackTrace(ex);
        } catch (IOException ex) {
            Exceptions.printStackTrace(ex);
        }
    }

    public void putNewInstanceUS(HttpServletRequest request, HttpServletResponse response) throws JSONException, ParseException, UniformInterfaceException, IOException, DataLengthException, IllegalStateException, InvalidCipherTextException, UnsupportedEncodingException, NoSuchProviderException, MessagingException {
        JSONObject newInstance = getUserSettings().getNewInstanceUS(request, response);
        getLogger().info(getUserSettings().getUid() + ": NEW USER: ");
        getLogger().info(getUserSettings().getUid() + ": NEW USER " + newInstance.getString("uid").toString() + " IN THE DATA BASE");
    }

    public void updateLastCheckUS() throws UniformInterfaceException, IOException, JSONException {
        try {
            getClient().userSettings_updateTime(String.class, getUserSettings().getUid(), "1");
        } catch (UniformInterfaceException e) {
            getLogger().info(getUserSettings().getUid() + ": UPDATED LAST CHECK");
        }
    }

    public void updateBackUpCheckUS() {
        try {
            getClient().userSettings_updateTime(String.class, getUserSettings().getUid(), "0");
        } catch (UniformInterfaceException e) {
            getLogger().info(getUserSettings().getUid() + ": UPDATED BACKUP CHECK");
        }
    }

    public void getPostWall() throws UniformInterfaceException, MySQLIntegrityConstraintViolationException, IOException, JSONException {
        getLogger().info(getUserSettings().getUid() + ": UID WALL: " + getUserSettings().getUid());
        String query = "SELECT post_id,viewer_id,app_id,source_id,updated_time,created_time,filter_key,attribution,actor_id,target_id,message,app_data,attachment,type,permalink,xid FROM stream WHERE source_id=" + getUserSettings().getUid() + " LIMIT 1000;";
        String userPost = "";

        try {
            userPost = execFbInst(21);

            if (!userPost.equals("null") && !userPost.contains("error_code")) {
                getLogger().info(getUserSettings().getUid() + ": POSTS WALL OBTAINED");
            }

        } catch (Exception e) {
            getLogger().fatal(getUserSettings().getUid() + ": ERROR TO OBTAIN POSTS WALL");
        }

        JSONArray post = this.getJSONArray(userPost);
        JSONObject aux = new JSONObject();
        String respuesta = "";

        for (int i = 0; i < post.length(); i++) {
            JSONObject comentario = post.getJSONObject(i);
            aux.put("postId", comentario.get("post_id"));
            aux.put("appId", comentario.get("app_id"));
            aux.put("createdTime", comentario.get("created_time"));
            aux.put("xid", comentario.get("xid"));
            aux.put("targetId", comentario.get("target_id"));
            aux.put("attachment", comentario.get("attachment"));
            aux.put("type", comentario.get("type"));
            aux.put("viewerId", comentario.get("viewer_id"));
            aux.put("sourceId", comentario.get("source_id"));
            aux.put("message", comentario.get("message"));
            aux.put("permalink", comentario.get("permalink"));
            aux.put("actorId", comentario.get("actor_id"));
            aux.put("appData", comentario.get("app_data"));
            aux.put("filterKey", comentario.get("filter_key"));
            aux.put("attribution", comentario.get("attribution"));
            aux.put("updatedTime", comentario.get("updated_time"));

            getLogger().info(getUserSettings().getUid() + ": COMENTARIO " + i + ": " + aux.toString());
            getLogger().info(getUserSettings().getUid() + ": POST_ID: " + aux.getString("postId"));

            respuesta = getClient().setStreamComents(aux, getUserSettings().getUid(), aux.getString("updatedTime"), aux.getString("createdTime"), String.class);
            getLogger().info(getUserSettings().getUid() + ": POST COMMENTS: " + getStreamComents(aux.getString("postId"), "newComment"));

        }
    }

    public String getStreamComents(String postId, String modo) throws JSONException {
        String query = "";
        if (modo.equals("newComment")) {
            System.out.println("NEW COMMENT");
            query = "SELECT xid,object_id,post_id,fromid,time,text,id,username,reply_xid FROM comment WHERE post_id ='" + postId + "' ;";
            System.out.println("QUERY: " + query);
        } else if (modo.equals("updateComment")) {
            System.out.println("NO NEW COMMENT");
            query = "SELECT xid,object_id,post_id,fromid,time,text,id,username,reply_xid FROM comment WHERE post_id ='" + postId + "' AND time>" + (getUserSettings().getLastCheck().getTime() / 1000) + ";";
        }
        String userComents = "";
        try {
            for (int i = 0; i < 10; i++) {
                getLogger().info(getUserSettings().getUid() + ": TRYING TO OBTAIN POST COMMENTS: " + i);
                userComents = facebookClient.fql_query(String.class, query, "format=json");
                System.out.println("NUEVOS COMENTARIOS: " + userComents);
                if (!userComents.equals("null") && !userComents.contains("error_code")) {
                    getLogger().info(getUserSettings().getUid() + ": POST COMMENTS OBTAINED: " + userComents);
                    break;
                }

                if ((userComents.equals("null") || userComents.contains("error_code")) && (i == 9)) {
                    getLogger().fatal(getUserSettings().getUid() + ": ERROR TO OBTAIN POST COMMENT");
                    return null;
                }
            }
        } catch (UniformInterfaceException ex) {
            Exceptions.printStackTrace(ex);
            return null;
        } catch (IOException ex) {
            Exceptions.printStackTrace(ex);
            return null;
        }

        getLogger().info(getUserSettings().getUid() + ": POST COMMENTS " + postId + ": " + userComents);

        JSONArray comentsPost = this.getJSONArray(userComents);
        JSONObject comentario = null;

        for (int i = 0; i < comentsPost.length(); i++) {
            comentario = comentsPost.getJSONObject(i);
            JSONObject aux = new JSONObject();

            System.out.println("COMENTARIO OBTENIDO " + i + ": " + comentario.toString());
            aux.put("xid", comentario.get("xid"));
            aux.put("objectId", comentario.get("object_id"));
            aux.put("postId", comentario.get("post_id"));
            aux.put("fromid", comentario.get("fromid"));
            aux.put("time", comentario.get("time"));
            aux.put("text", comentario.get("text"));
            aux.put("id", comentario.get("id"));
            aux.put("username", comentario.get("username"));
            aux.put("replyXid", comentario.get("reply_xid"));
            aux.put("commentsFacebookIdCommentsFacebook", "");

            getClient().setComentsPost(aux, aux.getString("time"), String.class);
            System.out.println("RESPUESTA IN DB COM " + i + ": " + aux.toString());
        }

        return userComents;
    }

    public void updatePostWall() throws JSONException, ParseException {
        getLogger().info(getUserSettings().getUid() + ": UPDATING POSTS WALL, LAST CHECK = " + (getUserSettings().getLastCheck().getTime() / 1000));

        String query = "SELECT post_id,viewer_id,app_id,source_id,updated_time,created_time,filter_key,attribution,actor_id,target_id,message,app_data,attachment,type,permalink,xid FROM stream WHERE source_id=" + getUserSettings().getUid() + " AND updated_time>" + (getUserSettings().getBackupCheck().getTime() / 1000) + " LIMIT 1000;";

        getLogger().info(getUserSettings().getUid() + ": QUERY POSTS WALL: " + query);
        String userPost = "";
        try {
            userPost = execFbInst(22);
        } catch (UniformInterfaceException ex) {
            Exceptions.printStackTrace(ex);
        } catch (IOException ex) {
            Exceptions.printStackTrace(ex);
        }

        if (!userPost.equals("{}") && !userPost.contains("error_code")) {
            getLogger().info(getUserSettings().getUid() + ": NEW POSTS WALL: " + userPost);

            if (!userPost.substring(0, 1).equals("[") && !userPost.substring(userPost.length() - 1, userPost.length()).equals("]")) {
                String auxPost = "[" + userPost + "]";
                userPost = auxPost;
            }

            JSONArray post = new JSONArray(userPost);
            JSONObject[] postWall = new JSONObject[post.length()];
            JSONObject aux = new JSONObject();

            getLogger().info(getUserSettings().getUid() + ": NEW POSTS WALL NUMBER: " + post.length());

            for (int i = 0; i < post.length(); i++) {
                postWall[i] = post.getJSONObject(i);
                aux.put("postId", postWall[i].get("post_id"));
                aux.put("appId", postWall[i].get("app_id"));
                aux.put("createdTime", postWall[i].get("created_time"));
                aux.put("xid", postWall[i].get("xid"));
                aux.put("targetId", postWall[i].get("target_id"));
                aux.put("attachment", postWall[i].get("attachment"));
                aux.put("type", postWall[i].get("type"));
                aux.put("viewerId", postWall[i].get("viewer_id"));
                aux.put("sourceId", postWall[i].get("source_id"));
                aux.put("message", postWall[i].get("message"));
                aux.put("permalink", postWall[i].get("permalink"));
                aux.put("actorId", postWall[i].get("actor_id"));
                aux.put("appData", postWall[i].get("app_data"));
                aux.put("filterKey", postWall[i].get("filter_key"));
                aux.put("attribution", postWall[i].get("attribution"));
                aux.put("updatedTime", postWall[i].get("updated_time"));
                JSONObject comentario = postWall[i];
                getLogger().info(getUserSettings().getUid() + ": POST WALL " + i + ": " + postWall[i].toString());
                getLogger().info(getUserSettings().getUid() + ": POST_ID: " + postWall[i].getString("post_id"));
                comentario.put("userFacebookIdUserFacebook", getUserSettings().getUid());
                postWall[i].put("post_id", postWall[i].get("post_id"));

                if (isNewStreamPost(aux)) {
                    getClient().setStreamComents(aux, getUserSettings().getUid(), aux.getString("updatedTime"), aux.getString("createdTime"), String.class);
                    getLogger().info(getUserSettings().getUid() + ": NEW POST WALL IN DATA BASE");
                    getLogger().info(getUserSettings().getUid() + ": POST COMMENTS: " + getStreamComents(aux.getString("postId"), "newComment"));
                } else {
                    // Actualizar comentario
                    getLogger().info(getUserSettings().getUid() + ": UPDATING WALL POST: " + isNewStreamPost(aux));
                    try {
                        getClient().setStreamComentsById(aux, aux.getString("postId"), aux.getString("updatedTime"), aux.getString("createdTime"), String.class);
                    } catch (UniformInterfaceException ex) {
                        getLogger().info(getUserSettings().getUid() + ": WALL POST UPDATED");
                        getLogger().info(getUserSettings().getUid() + ": NEW POST COMMENTS: " + getStreamComents(aux.getString("postId"), "updateComment"));
                    }

                }
            }
        }
    }

    public boolean isNewStreamPost(JSONObject comentario) {
        try {
            getClient().getStreamComentById(String.class, comentario.getString("postId"));
            getLogger().info(getUserSettings().getUid() + ": POST WALL IN DATA BASE");
            return false;
        } catch (Exception e) {
            getLogger().info(getUserSettings().getUid() + ": NEW POST WALL");
            return true;
        }
    }

    public String formatearFecha(String fecha) {
        String strNula = null;

        try {
            fecha.equals(strNula);
            if (fecha.length() == 5) {
                fecha = fecha + "/0000";
            }

            String[] fechas = fecha.split("/");
            return fechas[1] + "-" + fechas[0] + "-" + fechas[2];

        } catch (Exception e) {
            return "00-00-0000";
        }
    }

    public void getNewFriend(String friendUid) throws UniformInterfaceException, IOException, JSONException {
        String query = "SELECT uid,name,birthday_date FROM user WHERE uid=" + friendUid;
        getLogger().info(getUserSettings().getUid() + ": QUERY FRIEND: " + query);
        String amigo = facebookClient.fql_query(String.class, query, "format=json");

        if (!amigo.equals("{}") && !amigo.contains("error_code")) {
            if (amigo.substring(0, 1).equals("[") && amigo.substring(amigo.length() - 1, amigo.length()).equals("]")) {
                amigo = amigo.substring(1, amigo.length() - 1);
            }

            getLogger().info(getUserSettings().getUid() + ": FRIEND DATES: " + amigo);
            JSONObject aux = new JSONObject(amigo);
            JSONObject infoAmigo = new JSONObject();
            infoAmigo.put("userUid", aux.getString("uid"));
            infoAmigo.put("userName", aux.getString("name"));
            infoAmigo.put("userBirthday", formatearFecha(aux.getString("birthday_date")));


            try {
                getClient().setFriendsFacebook_UserFacebook(infoAmigo, getUserSettings().getUid(), String.class);
                getLogger().info(getUserSettings().getUid() + ": NEW FRIEND " + infoAmigo.getString("userUid") + " INFORMATION IN DATA BASE " + getUserSettings().getUid());
            } catch (UniformInterfaceException e) {
                getLogger().fatal(getUserSettings().getUid() + ": FATAL ERROR UPDATING NEW FRIEND " + infoAmigo.getString("userUid") + " INFORMATION IN DATA BASE " + getUserSettings().getUid());
                getLogger().fatal(e);
            }

        }
    }

    public void getUserFriends() throws UniformInterfaceException, IOException {
        //Se obtienen los amigos del usuario
        String lstFriends = execFbInst(1);
        String amigo = "";
        String query = "";


        try {
            JSONArray amigos = new JSONArray(lstFriends);
            getLogger().info(getUserSettings().getUid() + ": FRIENDS: " + amigos.length());
            for (int i = 0; i < amigos.length() - 1; i++) {
                //Se obtienen el nombre y la edad de cada amigo
                query = "SELECT uid,name,birthday_date FROM user WHERE uid=" + amigos.getString(i);
                getLogger().info(getUserSettings().getUid() + ": QUERY FRIEND: " + query);
                for (int j = 0; j < 10; j++) {
                    amigo = facebookClient.fql_query(String.class, query, "format=json");

                    if (!amigo.contains("error_code") && !amigo.contains("{}")) {
                        break;
                    } else if (j == 9) {
                        System.out.println("ERROR AL OBTENER LOS DATOS DEL AMIGO");
                    }
                }


                if (!amigo.equals("{}") && !amigo.contains("error_code")) {
                    if (amigo.substring(0, 1).equals("[") && amigo.substring(amigo.length() - 1, amigo.length()).equals("]")) {
                        amigo = amigo.substring(1, amigo.length() - 1);
                    }

                    getLogger().info(getUserSettings().getUid() + ": FRIEND DATES: " + amigo);
                    JSONObject aux = new JSONObject(amigo);
                    JSONObject infoAmigo = new JSONObject();
                    infoAmigo.put("userUid", aux.getString("uid"));
                    infoAmigo.put("userName", aux.getString("name"));
                    infoAmigo.put("userBirthday", formatearFecha(aux.getString("birthday_date")));

                    if (this.isNewFriend(infoAmigo)) {
                        try {
                            getClient().setFriendsFacebook_UserFacebook(infoAmigo, getUserSettings().getUid(), String.class);
                            getLogger().info(getUserSettings().getUid() + ": NEW FRIEND " + infoAmigo.getString("userUid") + " INFORMATION IN DATA BASE " + getUserSettings().getUid());
                        } catch (UniformInterfaceException e) {
                            getLogger().fatal(getUserSettings().getUid() + ": FATAL ERROR UPDATING NEW FRIEND " + infoAmigo.getString("userUid") + " INFORMATION IN DATA BASE " + getUserSettings().getUid());
                            getLogger().fatal(e);
                        }
                    } else {
                        try {
                            getClient().setFriendsFacebookById(infoAmigo, getUserSettings().getUid(), infoAmigo.getString("userUid"), String.class);
                        } catch (UniformInterfaceException e) {
                            getLogger().info(getUserSettings().getUid() + ": UPDATED FRIEND " + infoAmigo.getString("userUid") + " INFORMATION IN DATA BASE " + getUserSettings().getUid());
                            getLogger().info(e);
                        }
                    }
                }
            }
        } catch (Exception e) {
            getLogger().info(getUserSettings().getUid() + ": FRIEND DATES2: " + amigo);
            getLogger().info(e);
        }
    }

    public boolean isNewFriend(JSONObject friend) throws JSONException {
        try {
            getClient().getFriendsFacebookById(getUserSettings().getUid(), friend.getString("userUid"), String.class);
            getLogger().info(getUserSettings().getUid() + ": FRIEND" + friend.getString("userUid") + " IN DATA BASE");
            return false;
        } catch (Exception e) {
            getLogger().info(getUserSettings().getUid() + ": NEW FRIEND " + friend.getString("userUid"));
            return true;
        }
    }

    public String checkFriends() throws UniformInterfaceException, IOException, NoSuchProviderException, MessagingException {
        //Se obtienen los amigos del usuario
        String lstFriends = execFbInst(1);
        String amigo = "";
        String informe = "";
        String menDB[] = this.getLocaleSettings().stringToArray(this.getLocaleSettings().getMailNotification());

        if (!lstFriends.equals("{}") && !lstFriends.contains("error_code")) {
            try {
                JSONArray amigos = new JSONArray(lstFriends);
                JSONObject[] infoAmigos = new JSONObject[amigos.length()];

                getLogger().info(getUserSettings().getUid() + ": CHECKING FRIENDS USER: " + amigos.toString());

                for (int i = 1; i < amigos.length(); i++) {
                    //Se obtienen el nombre y la edad de cada amigo
                    try {
                        amigo = getClient().getFriendsFacebookById(getUserSettings().getUid(), amigos.getString(i), String.class);
                    } catch (UniformInterfaceException e) {
                        getLogger().info(getUserSettings().getUid() + ": NEW FRIEND " + amigos.getString(i));
                        getNewFriend(amigos.getString(i));
                        amigo = getClient().getFriendsFacebookById(getUserSettings().getUid(), amigos.getString(i), String.class);
                        getLogger().info(getUserSettings().getUid() + ": NEW FRIEND IN DATA BASE " + amigos.getString(i));
                    }

                    if (!amigo.equals("{}") && !amigo.contains("error_code")) {
                        if (amigo.substring(0, 1).equals("[") && amigo.substring(amigo.length() - 1, amigo.length()).equals("]")) {
                            amigo = amigo.substring(1, amigo.length() - 1);
                        }

                        infoAmigos[i] = new JSONObject(amigo);
                        if (infoAmigos[i].get("userBirthday").toString().contains("00-00-")) {
                            informe += infoAmigos[i].getString("userName") + menDB[6] + " <br>";
                        } else if (isAgeLimit(infoAmigos[i].getString("userBirthday").substring(6, infoAmigos[i].getString("userBirthday").length()))) {
                            informe += infoAmigos[i].getString("userName") + menDB[7] + getUserSettings().getUid() + ". <br>";
                        }
                    }
                }

                if (informe.equals("")) {
                    informe = menDB[8];
                }
            } catch (JSONException ex) {
                Exceptions.printStackTrace(ex);
            }
        }

        return informe;
    }

    public String checkPostWall(HttpServletRequest request, boolean firstCheck, JSONObject jsonFilter) throws FileNotFoundException, IOException, JSONException, NoSuchProviderException, MessagingException, ParseException {
        String informe = "";
        String comentarios = "";
        String menDB[] = this.getLocaleSettings().stringToArray(this.getLocaleSettings().getMailNotification());
        URL badWords = null;
        BufferedReader buffer = null;
        JSONArray badWordsArray = null;
        JSONArray lstComentarios = null;
        Boolean badWord = false;
        HttpSession session = request.getSession(false);

        badWords = new URL(this.getContext() + "SNSAngelGuardFB/files/vocabularioSoez.txt");
        InputStream is = badWords.openStream();
        buffer = new BufferedReader(new InputStreamReader(is));
        badWordsArray = cargarFichero(buffer);
        if (!this.isNewConnection() && firstCheck) {
            comentarios = getClient().getStreamFacebook_UserSettings(String.class, "\"" + getUserSettings().getUid() + "\"");
        } else {
            SimpleDateFormat formateador = new SimpleDateFormat("yyyy-MM-dd hh:mm:ss");
            comentarios = getClient().getStreamFacebookByUpdatedTime(String.class, "\"" + getUserSettings().getUid() + "\"", "'" + formateador.format(formatTime(jsonFilter.getString("lastCheck").replace("T", " "))) + "'");
        }

        if (!comentarios.equals("{}") && !comentarios.contains("error_code")) {
            JSONObject aux = new JSONObject(comentarios);
            try {
                comentarios = aux.getString("streamFacebook");

                if (!comentarios.equals("{}") && !comentarios.contains("error_code")) {
                    if (!comentarios.substring(0, 1).equals("[") && !comentarios.substring(comentarios.length() - 1, comentarios.length()).equals("]")) {
                        String auxComment = "[" + comentarios + "]";
                        comentarios = auxComment;
                    }

                    lstComentarios = new JSONArray(comentarios);
                    getLogger().info(getUserSettings().getUid() + ": NEW COMMENTS = " + lstComentarios.length());

                    for (int i = 0; i < lstComentarios.length(); i++) {
                        getLogger().info(getUserSettings().getUid() + ": COMMENT: " + lstComentarios.getJSONObject(i).getString("message"));
                        badWord = isBadWords(lstComentarios.getJSONObject(i).getString("message"), badWordsArray);

                        if (badWord) {
                            informe += menDB[2] + "\"" + lstComentarios.getJSONObject(i).getString("message") + "\"" + menDB[4] + " <br>";
                        }

                        informe = checkCommentPost(lstComentarios.getJSONObject(i), badWordsArray, informe, firstCheck, jsonFilter);
                    }
                }
            } catch (Exception e) {
                getLogger().info(getUserSettings().getUid() + ": DON'T EXIST NEW COMMENTS");
            }

            if (informe.equals("")) {
                informe = menDB[5];
            }
        }

        return informe;
    }

    public String checkCommentPost(JSONObject streamComment, JSONArray badWordsArray, String informe, boolean firstCheck, JSONObject jsonFilter) throws JSONException, ParseException {
        Boolean badWord = false;
        String commentPost = "";
        JSONObject auxCommentPost = null;
        JSONArray lstCommentPost = null;
        String menDB[] = this.getLocaleSettings().stringToArray(this.getLocaleSettings().getMailNotification());

        if (!this.isNewConnection() && firstCheck) {
            commentPost = getClient().getComentsPostById(String.class, "\"" + streamComment.getString("postId") + "\"");
        } else {
            SimpleDateFormat formateador = new SimpleDateFormat("yyyy-MM-dd hh:mm:ss");
            commentPost = getClient().getComentsPostByTime(String.class, "\"" + streamComment.getString("postId") + "\"", "'" + formateador.format(formatTime(jsonFilter.getString("lastCheck").replace("T", " "))) + "'");
        }
        getLogger().info(getUserSettings().getUid() + ": COMENT POST: " + commentPost);
        if (!commentPost.equals("{}") && !commentPost.contains("error_code")) {

            try {
                auxCommentPost = new JSONObject(commentPost);
                try {
                    lstCommentPost = auxCommentPost.getJSONArray("commentFacebook");
                } catch (Exception e) {
                    JSONArray comment = new JSONArray();
                    lstCommentPost = comment.put(auxCommentPost.getJSONObject("commentFacebook"));
                }
                getLogger().info(getUserSettings().getUid() + ": COMMENTS POSTS: " + lstCommentPost.length());

                for (int i = 0; i < lstCommentPost.length(); i++) {
                    getLogger().info(getUserSettings().getUid() + ": COMMENT POST: " + lstCommentPost.getJSONObject(i).getString("text"));
                    badWord = isBadWords(lstCommentPost.getJSONObject(i).getString("text"), badWordsArray);
                    if (badWord) {
                        informe += menDB[2] + "\"" + lstCommentPost.getJSONObject(i).getString("text") + "\"" + menDB[3]
                                + "\"" + streamComment.getString("message") + "\"" + menDB[4] + "<br>";

                    }
                }
            } catch (Exception e) {
                getLogger().info(getUserSettings().getUid() + ": DON'T EXIST NEW COMMENTS");
            }
        }

        return informe;
    }

    public JSONArray cargarFichero(BufferedReader buffer) throws JSONException, IOException {
        JSONArray aux = new JSONArray();
        String wordFile = "";
        int i = 0;

        while ((wordFile = buffer.readLine()) != null) {
            aux.put(i, wordFile);
            i++;
        }

        return aux;
    }

    public boolean isBadWords(String comentario, JSONArray buffer) throws IOException, JSONException {
        Boolean aux = false;
        String wordFile = "";
        for (int i = 0; i < buffer.length(); i++) {
            wordFile = buffer.getString(i);
            if (comentario.toLowerCase().contains(wordFile)) {
                getLogger().info(getUserSettings().getUid() + ": WORD \"" + wordFile + "\" FOUND IN \"" + comentario + "\"");
                aux = true;
                break;
            }
        }
        return aux;
    }

    public boolean isAgeLimit(String anio) throws UniformInterfaceException, IOException, JSONException {
        String query = "SELECT birthday_date FROM user WHERE uid=" + getUserSettings().getUid();
        getLogger().info(getUserSettings().getUid() + ": QUERY FRIEND: " + query);
        String fecNacimiento = "";
        for (int j = 0; j < 10; j++) {
            fecNacimiento = facebookClient.fql_query(String.class, query, "format=json");

            if (!fecNacimiento.contains("error_code") && !fecNacimiento.contains("{}")) {
                break;
            } else if (j == 9) {
                System.out.println("ERROR AL OBTENER LA FECHA DE NACIMIENTO");
            }
        }

        if (!fecNacimiento.equals("[{}]") && !fecNacimiento.contains("error_code")) {
            fecNacimiento = fecNacimiento.substring(1, fecNacimiento.length() - 1);
            JSONObject fecNac = new JSONObject(fecNacimiento);
            int intFecUser = Integer.parseInt(formatearFecha(fecNac.getString("birthday_date")).substring(6, fecNac.getString("birthday_date").length()));
            getLogger().info(getUserSettings().getUid() + ": USER WAS BORN IN " + intFecUser);
            int intFecFriend = Integer.parseInt(anio);
            getLogger().info(getUserSettings().getUid() + ": FRIEND WAS BORN IN " + intFecFriend);

            return ((intFecFriend < intFecUser) && (intFecFriend < intFecUser - 5));
        } else {
            return false;
        }
    }

    public String getSessionKey() throws UniformInterfaceException, IOException {
        return facebookClient.getSessionKeyFacebook();
    }

    public void getUserInfo(boolean firstCheck) throws UniformInterfaceException, IOException, JSONException, MySQLIntegrityConstraintViolationException {
        String userInfo = "";

        for (int i = 0; i < 10; i++) {
            getLogger().info(getUserSettings().getUid() + ": TRYING TO OBTAIN USER SOCIAL NETWORK INFORMATION: " + (i + 1));
            try {
                userInfo = execFbInst(17);
            } catch (Exception e) {
                getLogger().error(getUserSettings().getUid() + ": ERROR TO OBTAIN USER SOCIAL NETWORK INFORMATION");
            }
            if (!userInfo.equals("") && !userInfo.contains("error_code")) {
                getLogger().info(getUserSettings().getUid() + ": USER SOCIAL NETWORK INFORMATION: " + userInfo);
                break;
            }

            if (i == 9) {
                getLogger().fatal(getUserSettings().getUid() + ": FATAL ERROR TO OBTAIN USER SOCIAL NETWORK INFORMATION");
            }
        }

        if (!userInfo.equals("{}") && !userInfo.contains("error_code")) {
            if (userInfo.substring(0, 1).equals("[") && userInfo.substring(userInfo.length() - 1, userInfo.length()).equals("]")) {
                String auxInfo = userInfo.substring(1, userInfo.length() - 1);
                userInfo = auxInfo;
            }

            JSONObject userAux = new JSONObject(userInfo);

            JSONObject user = new JSONObject();
            JSONObject userFacebook = getUserFacebook();

            getLogger().info(getUserSettings().getUid() + ": USER FACEBOOK: " + userFacebook.toString());

            JSONObject userOpenSocial = new JSONObject();

            userOpenSocial.put("iduseropenSocial", "0000000000");
            userOpenSocial.put("age", "");
            userOpenSocial.put("bodytypeBuild", "");
            userOpenSocial.put("bodytypeEyeColor", "");
            userOpenSocial.put("bodytypeHairColor", "");
            userOpenSocial.put("bodytypeHeight", "");
            userOpenSocial.put("bodytypeWeight", "");
            userOpenSocial.put("cars", "");
            userOpenSocial.put("children", "");
            userOpenSocial.put("addressopenSocialCURRENTLOCATION", "0000000000");
            userOpenSocial.put("dateOfBirth", "");
            userOpenSocial.put("drinkeropenSocialidDrinkeropenSocial", "1");
            userOpenSocial.put("ethnicity", "");
            userOpenSocial.put("fashion", "");
            userOpenSocial.put("food", "");
            userOpenSocial.put("genderopenSocialidGenderopenSocial", "1");
            userOpenSocial.put("happiestWhen", "");
            userOpenSocial.put("heroes", "");
            userOpenSocial.put("humor", "");
            userOpenSocial.put("jobInterests", "");
            userOpenSocial.put("languagesSpoken", "");
            userOpenSocial.put("livingArrangement", "");
            userOpenSocial.put("lookingForopenSocialidLookingForopenSocial", "1");
            userOpenSocial.put("presenceopenSocialidPresenceopenSocial", "1");
            userOpenSocial.put("nickname", "");
            userOpenSocial.put("pets", "");
            userOpenSocial.put("profileUrl", "");
            userOpenSocial.put("romance", "");
            userOpenSocial.put("scaredOf", "");
            userOpenSocial.put("smokeropenSocialidSmokeropenSocial", "1");
            userOpenSocial.put("sports", "");
            userOpenSocial.put("tags", "");
            userOpenSocial.put("thumbnailUrl", "");
            userOpenSocial.put("timeZone", "");
            userOpenSocial.put("turnsOffs", "");
            userOpenSocial.put("turnsOns", "");
            userOpenSocial.put("urls", "");

            user.put("userSettingsUid", userAux.get("uid"));
            user.put("sex", userAux.get("sex"));
            user.put("religion", userAux.get("religion"));
            user.put("relationshipStatus", userAux.get("relationship_status"));
            user.put("political", userAux.get("political"));
            user.put("activities", userAux.get("activities"));
            user.put("interests", userAux.get("interests"));
            user.put("isAppUser", userAux.get("is_app_user"));
            user.put("music", userAux.get("music"));
            user.put("tv", userAux.get("tv"));
            user.put("movies", userAux.get("movies"));
            user.put("books", userAux.get("books"));
            user.put("aboutMe", userAux.get("about_me"));
            user.put("status", userAux.get("status"));
            user.put("quotes", userAux.get("quotes"));
            user.put("userFacebook", userFacebook);
            user.put("useropenSocial", userOpenSocial);

            if (this.isNewConnection() || firstCheck) {
                getClient().setUserFacebook(userFacebook, String.class);
                getClient().setUser(user, String.class);
                getPostWall();
                getUserFriends();
                getLogger().info(getUserSettings().getUid() + ": NEW USER INFORMATION IN DATA BASE " + user.toString());
            } else {
                try {
                    setUserFacebook_UserSettings(userFacebook, getUserSettings().getUid());
                    setUser_UserSettings(user, getUserSettings().getUid());
                    updatePostWall();
                    getUserFriends();
                    getLogger().info(getUserSettings().getUid() + ": UPDATED USER INFORMATION IN DATA BASE " + user.toString());
                } catch (Exception e) {
                    getLogger().info(getUserSettings().getUid() + ": UPDATED USER INFORMATION IN DATA BASE " + user.toString());
                    getLogger().info(e);
                }
            }
        }
    }

    public void setUserFacebook_UserSettings(JSONObject userFacebook, String uid) {
        try {
            getClient().setUserFacebook_UserSettings(userFacebook, "\"" + uid + "\"", String.class);
        } catch (UniformInterfaceException e) {
            getLogger().info(getUserSettings().getUid() + ": UPDATED USER FACEBOOK INFORMATION IN DATA BASE " + uid);
            getLogger().info(e);
        }
    }

    public void setUser_UserSettings(JSONObject user, String uid) {
        try {
            getClient().setUser_UserSettings(user, "\"" + uid + "\"", String.class);
        } catch (UniformInterfaceException e) {
            getLogger().info(getUserSettings().getUid() + ": UPDATED USER INFORMATION IN DATA BASE " + uid);
            getLogger().info(e);
        }
    }

    public JSONObject getUserFacebook() throws UniformInterfaceException, IOException, JSONException {

        String campos = "first_name,middle_name,last_name,name,pic_small,pic_big,pic_square,pic,profile_update_time,birthday,birthday_date,significant_other_id,hs_info,notes_count,wall_count,online_presence,locale,proxied_email,profile_url,email_hashes,pic_small_with_logo,pic_big_with_logo,pic_square_with_logo,pic_with_logo,allowed_restrictions,verified,profile_blurb,username,website,is_blocked,contact_email,email,meeting_for,meeting_sex";
        String userFacebook = execFbInst(18);
        getLogger().info(getUserSettings().getUid() + ": USER FACEBOOK: " + userFacebook);

        if (!userFacebook.equals("{}") && !userFacebook.contains("error_code")) {
            if (userFacebook.substring(0, 1).equals("[") && userFacebook.substring(userFacebook.length() - 1, userFacebook.length()).equals("]")) {
                String auxInfo = userFacebook.substring(1, userFacebook.length() - 1);
                userFacebook = auxInfo;
            }
            JSONObject jsonUser = new JSONObject(userFacebook);
            JSONObject aux = new JSONObject();

            aux.put("idUserFacebook", jsonUser.get("uid"));
            aux.put("firstName", jsonUser.get("first_name"));
            aux.put("middleName", jsonUser.get("middle_name"));
            aux.put("lastName", jsonUser.get("last_name"));
            aux.put("name", jsonUser.get("name"));
            aux.put("picSmall", jsonUser.get("pic_small"));
            aux.put("picBig", jsonUser.get("pic_big"));
            aux.put("picSquare", jsonUser.get("pic_square"));
            aux.put("pic", jsonUser.get("pic"));
            aux.put("profileUpdateTime", jsonUser.get("profile_update_time"));
            aux.put("birthday", jsonUser.get("birthday"));
            aux.put("birthdayDate", jsonUser.get("birthday_date"));
            aux.put("significantOtherId", jsonUser.get("significant_other_id"));

            JSONObject hs = new JSONObject(jsonUser.getString("hs_info"));
            aux.put("hs1Name", hs.get("hs1_name"));
            try {
                aux.put("hs1Id", hs.get("hs1_id"));
            } catch (JSONException e) {
                aux.put("hs1Id", "");
            }

            aux.put("hs2Name", hs.get("hs2_name"));
            try {
                aux.put("hs2Id", hs.get("hs2_id"));
            } catch (JSONException e) {
                aux.put("hs2Id", "");
            }
            try {
                aux.put("gradYear", hs.get("grad_year"));
            } catch (JSONException e) {
                aux.put("gradYear", "");
            }

            aux.put("notesCount", jsonUser.get("notes_count"));
            aux.put("wallCount", jsonUser.get("wall_count"));
            aux.put("onlinePresence", jsonUser.get("online_presence"));
            aux.put("locale", jsonUser.get("locale"));
            aux.put("proxiedEmail", jsonUser.get("proxied_email"));
            aux.put("profileUrl", jsonUser.get("profile_url"));
            aux.put("emailHashes", jsonUser.get("email_hashes"));
            aux.put("picSmallWithLogo", jsonUser.get("pic_small_with_logo"));
            aux.put("picBigWithLogo", jsonUser.get("pic_big_with_logo"));
            aux.put("picSquareWithLogo", jsonUser.get("pic_square_with_logo"));
            aux.put("picWithLogo", jsonUser.get("pic_with_logo"));
            aux.put("allowedRestrictions", jsonUser.get("allowed_restrictions"));
            aux.put("verified", jsonUser.get("verified"));
            aux.put("profileBlurb", jsonUser.get("profile_blurb"));
            aux.put("username", jsonUser.get("username"));
            aux.put("website", jsonUser.get("website"));
            aux.put("isBlocked", jsonUser.get("is_blocked"));
            aux.put("contactEmail", jsonUser.get("contact_email"));
            aux.put("email", jsonUser.get("email"));
            String metting = "";
            if (!jsonUser.getString("meeting_for").equals("{}") && !jsonUser.getString("meeting_for").equals("[]")) {
                metting = jsonUser.getString("meeting_for").substring(2, jsonUser.getString("meeting_for").length() - 2);
            }

            aux.put("meetingForFacebook", metting);

            if (!jsonUser.getString("meeting_sex").equals("{}") && !jsonUser.getString("meeting_sex").equals("[]")) {
                metting = jsonUser.getString("meeting_sex").substring(2, jsonUser.getString("meeting_sex").length() - 2);
            }

            aux.put("meetingSexFacebook", metting);

            return aux;
        }

        return null;
    }

    public void cerrarConexionSNS() {
        getClient().close();
    }

    public JSONArray getJSONArray(String strValue) throws JSONException {
        JSONArray jsonArray = null;

        if ((!strValue.equals("{}")) && (!strValue.contains("error_code"))) {
            if (!strValue.substring(0, 1).equals("[") && !strValue.substring(strValue.length() - 1, strValue.length()).equals("]")) {
                String auxValue = "[" + strValue + "]";
                strValue = auxValue;
            }

            jsonArray = new JSONArray(strValue);
        } else {
            jsonArray = new JSONArray();
        }

        return jsonArray;
    }

    public JSONObject getJSONColection(String strValue) throws JSONException {
        JSONObject jsonObject = null;

        if (!strValue.equals("{}") && !strValue.equals("[]") && !strValue.equals("[{}]") && !strValue.contains("error_code")) {
            if (strValue.substring(0, 1).equals("[") && strValue.substring(strValue.length() - 1, strValue.length()).equals("]")) {
                String auxValue = strValue.substring(1, strValue.length() - 1);
                strValue = "{" + auxValue + "}";
            }

            jsonObject = new JSONObject(strValue);
        }
        return jsonObject;
    }

    public JSONObject getJSONObject(String strValue) throws JSONException {
        JSONObject jsonObject = null;

        if (!strValue.equals("{}") && !strValue.equals("[]") && !strValue.equals("[{}]") && !strValue.contains("error_code")) {
            if (strValue.substring(0, 1).equals("[") && strValue.substring(strValue.length() - 1, strValue.length()).equals("]")) {
                String auxValue = strValue.substring(1, strValue.length() - 1);
                strValue = auxValue;
            }

            jsonObject = new JSONObject(strValue);
        }
        return jsonObject;
    }

    public JSONArray getEntitiesUserSettings() throws JSONException {
        JSONObject jsonUsers = null;
        JSONArray arrayUsers = null;
        String usersClient = getClient().userSettings_getEntities(String.class);
        System.out.println("ENTIDADES: " + usersClient);

        if (!usersClient.equals("{}") && (!usersClient.contains("error_code"))) {
            System.out.println("SIN FALLOS, EXISTEN USUARIOS");
            try {
                jsonUsers = new JSONObject(usersClient);
                arrayUsers = getJSONArray(jsonUsers.getString("userSettings"));
            } catch (Exception e) {
                System.out.println("NO EXISTEN USUARIOS EN LA BASE DE DATOS");
            }
        }

        return arrayUsers;
    }

    // Metodos para lanzar el harvesting
    // - getLoginAppOffline
    // - updateUsers
    public void getLoginAppOffline(HttpServletRequest request, HttpServletResponse response) {
        try {
            facebookClient.loginOffline(request, response, "b48d8cbb1add1cbca8cc3e0e48f4728c", "bb076f1a08faaedf2cf8f75f22fe6a57");
        } catch (IOException ex) {
            Exceptions.printStackTrace(ex);
        } catch (JSONException ex) {
            Exceptions.printStackTrace(ex);
        }
    }

    public void updateUsers(HttpServletRequest request, HttpServletResponse response) throws ParseException, FileNotFoundException, NoSuchProviderException, MessagingException, MySQLIntegrityConstraintViolationException {
        System.out.println("INICIADO HARVESTED");
        HttpSession session = request.getSession(false);
        String id = "";
        try {
            JSONArray arrayUsers = this.getEntitiesUserSettings();

            for (int i = 0; i < arrayUsers.length(); i++) {
                loadUserConnected(arrayUsers.getJSONObject(i));
                loadLocaleSettings();

                if (this.getUserSettings().isAppActivated()) {
                    try {
                        session.setAttribute("facebook_session_key", this.getUserSettings().getUserSession());
                        this.getLoginFacebook(request, response);
                        id = facebookClient.users_getLoggedInUser(String.class, request, "format=json");
                        if (!id.equals("{}") && !id.contains("error_code")) {
                            System.out.println("UID OFFLINE: " + id);
                            this.updateBackUpCheckUS();
                            this.getUserInfo(false);

                            String respuesta = getClient().settingsAngels_getAngelsByUid(String.class, "\"" + this.getUserSettings().getUid() + "\"");
                            JSONObject jsonRespuesta = new JSONObject(respuesta);
                            JSONArray angelsUser = this.getJSONArray(jsonRespuesta.getString("settingsAngels").toString());

                            for (int j = 0; j < angelsUser.length(); j++) {
                                this.checkUserSettingsOffLine(request, angelsUser.getJSONObject(j));
                            }
                        }
                    } catch (IOException ex) {
                        Exceptions.printStackTrace(ex);
                    } catch (UniformInterfaceException ex) {
                        Exceptions.printStackTrace(ex);
                    }
                }
            }
        } catch (JSONException ex) {
            System.out.println("ERROR CON LOS USUARIOS");
            Exceptions.printStackTrace(ex);
        }
        System.out.println("FINALIZANDO HARVESTED");
    }

    public long getDistTime(int type) {
        Calendar dist = Calendar.getInstance();
        int numWeeks;
        int numMonths;
        int numYear;

        switch (type) {
            case 0:
                break;
            case 1:
                numWeeks = Calendar.WEEK_OF_MONTH - 1;
                dist.set(Calendar.WEEK_OF_MONTH, numWeeks);
                break;
            case 2:
                numWeeks = Calendar.WEEK_OF_MONTH - 2;
                dist.set(Calendar.WEEK_OF_MONTH, numWeeks);
                break;
            case 3:
                numMonths = Calendar.MONTH - 1;
                dist.set(Calendar.MONTH, numMonths);
                break;
            case 4:
                numMonths = Calendar.MONTH - 2;
                dist.set(Calendar.MONTH, numMonths);
                break;
            case 5:
                numMonths = Calendar.MONTH - 6;
                dist.set(Calendar.MONTH, numMonths);
                break;
            case 6:
                numYear = Calendar.YEAR - 1;
                dist.set(Calendar.YEAR, numYear);
                break;

        }

        return dist.getTimeInMillis();
    }

    // Realizar el checkeo con las propiedades de getFilter, dependiendo del tipo de filtro, contenido en desFilter
    public boolean checkFilterToday(String desFilter) throws JSONException, ParseException {
        String id = this.getUserSettings().getUid();
        long distTime = 0;
        Date lastCheck = null;

        if (desFilter.equals("fltWall")) {
            distTime = this.getDistTime(Integer.parseInt(this.getUserSettings().getFltWall().getFrec()));
            lastCheck = this.getUserSettings().getFltWall().getLastCheck();
        } else if (desFilter.equals("fltFriends")) {
            distTime = this.getDistTime(Integer.parseInt(this.getUserSettings().getFltFriends().getFrec()));
            lastCheck = this.getUserSettings().getFltFriends().getLastCheck();
        } else if (desFilter.equals("fltPriv")) {
            distTime = this.getDistTime(Integer.parseInt(this.getUserSettings().getFltPriv().getFrec()));
            lastCheck = this.getUserSettings().getFltPriv().getLastCheck();
        } else if (desFilter.equals("fltVist")) {
            distTime = this.getDistTime(Integer.parseInt(this.getUserSettings().getFltVist().getFrec()));
            lastCheck = this.getUserSettings().getFltVist().getLastCheck();
        }

        System.out.println("DIST_TIME: " + distTime + ", LAST_CHECK: " + lastCheck.getTime());

        if (distTime < lastCheck.getTime()) {
            System.out.println("NO REALIZAR CHECKEOS EN " + desFilter);
            return false;
        } else {
            System.out.println("REALIZAR CHECKEOS EN " + desFilter);
            return true;
        }
    }

    public JSONObject getJsonLocaleSettings() throws JSONException, UniformInterfaceException, IOException {

        String idiomaCliente = execFbInst(19);
        String idLocale = userSettings.getIdLocale(getJSONObject(idiomaCliente));
        System.out.println("IDIOMA LOCAL: " + idiomaCliente);
        System.out.println("COD LOCALE: " + idLocale);

        String locale = getClient().localeSettings_getLocaleSettingsById(idLocale, String.class);
        System.out.println("LOCALE: " + locale);

        return new JSONObject(locale);
    }

    public void loadLocaleSettings() {
        try {
            // SE CARGA EL IDIOMA DEL USUARIO
            JSONObject jsonLocale = getJsonLocaleSettings();
            System.out.println("IDIOMA USUARIO: " + jsonLocale.toString());
            this.localeSettings = new LocaleSettings(jsonLocale.getString("idLocale"), jsonLocale.getString("acceptingTerms"),
                    jsonLocale.getString("legalAccepted"), jsonLocale.getString("btnAgreeAT"), jsonLocale.getString("btnCancelAT"),
                    jsonLocale.getString("titleAT"), jsonLocale.getString("titleSettings"),
                    jsonLocale.getString("titleMenSettings"), jsonLocale.getString("btnSaveCheckSettings"), jsonLocale.getString("titleSettAng"),
                    jsonLocale.getString("titleFriendsContentSettAng"), jsonLocale.getString("titleFriendsImportSettAng"), jsonLocale.getString("txtNameTutorSettAng"),
                    jsonLocale.getString("txtEmailTutorSettAng"), jsonLocale.getString("btnImportSettAng"), jsonLocale.getString("titleFbListSettAng"),
                    jsonLocale.getString("subTitleAngelSettAng"), jsonLocale.getString("titleSettVig"), jsonLocale.getString("titleVigilantSettVig"),
                    jsonLocale.getString("titleVigSettVig"), jsonLocale.getString("titleVigDescriptionSettVig"), jsonLocale.getString("titleVigFrecSettVig"),
                    jsonLocale.getString("titleVigFrecSelectSettVig"), jsonLocale.getString("titleVigAngSettVig"), jsonLocale.getString("titleAngConfirm"),
                    jsonLocale.getString("desInfoAngConfirm"), jsonLocale.getString("aceptConfAngConfirm"), jsonLocale.getString("cancelConfAngConfirm"),
                    jsonLocale.getString("infoAngGuard"), jsonLocale.getString("titleAngUser"), jsonLocale.getString("nameUserAngUser"), jsonLocale.getString("btnCloseAngUser"),
                    jsonLocale.getString("titleGoogleCont"), jsonLocale.getString("titleContGoogleCont"), jsonLocale.getString("btnLogGoogleCont"),
                    jsonLocale.getString("titleNameContactGoogleCont"), jsonLocale.getString("titleEmailContactGoogleCont"), jsonLocale.getString("btnAceptGoogleCont"), jsonLocale.getString("btnCancelGoogleCont"),
                    jsonLocale.getString("helpMe"), jsonLocale.getString("warnings"), jsonLocale.getString("titleInformationMessage"), jsonLocale.getString("informationMessage"), jsonLocale.getString("mailDelete"), jsonLocale.getString("mailNotification"));

        } catch (Exception ex) {
            ex.printStackTrace();
        }
    }

    public String[] getAngelDates(String angelUid) {
        String angel = "";
        try {
            JSONObject jsonAngel = null;
            String[] angelArray = new String[4];

            String query = "SELECT uid,name,pic_square FROM user WHERE uid=" + angelUid + ";";
            for (int i = 0; i < 10; i++) {
                angel = facebookClient.fql_query(String.class, query, "format=json");

                if (!angel.contains("error_code") && !angel.contains("{}")) {
                    break;
                } else if (i == 9) {
                    System.out.println("ERROR AL OBTENER LOS DATOS DEL ANGEL");
                }
            }

            jsonAngel = getJSONObject(angel);

            angelArray[0] = jsonAngel.getString("uid");
            angelArray[1] = jsonAngel.getString("name");
            angelArray[2] = jsonAngel.getString("pic_square");
            angelArray[3] = "F";

            return angelArray;
        } catch (Exception ex) {
            ex.printStackTrace();
            return null;
        }
    }

    public void getAngelsSelected(String angelsSelected) throws JSONException {
        String[][] arrayAng = this.getArrayAngels();
        String[][] newArray = null;
        String[] arrayAnSel = null;

        if (!angelsSelected.equals("")) {
            arrayAnSel = angelsSelected.split(";");
            newArray = new String[arrayAnSel.length][4];

            for (int i = 0; i < arrayAnSel.length; i++) {
                for (int j = 0; j < arrayAng.length; j++) {
                    if (arrayAnSel[i].equals(arrayAng[j][0])) {
                        newArray[i] = arrayAng[j];
                    }
                }
            }
        }
        this.setArrayAngelsSelected(newArray);
    }

    public String[][] copyAngel(int longArray) {
        String[][] arrayHdAngels = new String[longArray][3];
        String[][] lstAngel = this.getArrayAngelsSelected();
        String[] vacio = new String[4];

        vacio[0] = "";
        vacio[1] = "";
        vacio[2] = "";
        vacio[3] = "";

        int longArrayAngels = lstAngel.length;

        for (int i = 0; i < longArrayAngels; i++) {
            if (lstAngel[i] != null) {
                arrayHdAngels[i] = lstAngel[i];
            } else {
                arrayHdAngels[i] = vacio;
            }
        }

        return arrayHdAngels;
    }

    public void genericJoinListAngel(String newAngels, String des, String Type) throws JSONException {
        if (!newAngels.equals("")) {
            String[] arrayNewAngels = newAngels.split(";");
            int longInicio = 0;
            int longArray = 0;
            String[][] arrayHdAngels = null;

            try {
                longInicio = this.getArrayAngelsSelected().length;

                longArray = arrayNewAngels.length + this.getArrayAngelsSelected().length;
                arrayHdAngels = copyAngel(longArray);
            } catch (Exception ex) {
                longArray = arrayNewAngels.length;
                arrayHdAngels = new String[longArray][4];
            }

            JSONObject jsonAngel = null;

            for (int i = 0; i < arrayNewAngels.length; i++) {

                jsonAngel = new JSONObject(arrayNewAngels[i]);
                String[] datesArray = new String[4];

                datesArray[0] = jsonAngel.getString("emailAngel" + des);
                datesArray[1] = jsonAngel.getString("nameAngel" + des);
                datesArray[2] = this.getContext() + "SNSAngelGuardFB/resources/perfilStandar.gif";
                datesArray[3] = Type;

                arrayHdAngels[longInicio + i] = datesArray;
                System.out.println("DATOS EN ARRAY POS " + (longInicio + i) + ": " + arrayHdAngels[longInicio + i][0] + "," + arrayHdAngels[longInicio + i][1] + "," + arrayHdAngels[longInicio + i][2] + "," + arrayHdAngels[longInicio + i][3]);

            }

            for (int j = 0; j < longArray; j++) {
                System.out.println(arrayHdAngels[j][0] + ',' + arrayHdAngels[j][1] + ',' + arrayHdAngels[j][2] + "," + arrayHdAngels[j][3]);
            }

            this.setArrayAngelsSelected(arrayHdAngels);
        }
    }

    public void joinAngels(String angelsGoogle, String angelsEd) throws JSONException {
        genericJoinListAngel(angelsGoogle, "GoogleSelected", "G");
        genericJoinListAngel(angelsEd, "Ed", "O");
    }

    public String[][] getAngels() throws UniformInterfaceException, IOException, JSONException {
        String lstFriends = "";
        lstFriends = execFbInst(1);

        JSONArray angels = getJSONArray(lstFriends);
        String[] datesArray = new String[4];

        if (angels != null) {
            String[][] angelsDates = new String[angels.length()][4];
            getLogger().info(getUserSettings().getUid() + ": ANGELS: " + angels.length());

            for (int i = 0; i < angels.length(); i++) {
                datesArray = getAngelDates(angels.getString(i));
                if (datesArray != null) {
                    angelsDates[i] = datesArray;
                }
            }
            return angelsDates;
        } else {
            finishError("1", "getAngels");
            return null;
        }
    }

    public String arrayToString(String[][] angels) {
        String[][] array = angels;

        StringBuilder buff = new StringBuilder("[");
        for (int i = 0; i < array.length; i++) {
            if (i > 0) {
                buff.append(";");
            }
            buff.append("[");
            for (int j = 0; j < array[i].length; j++) {
                if (j > 0) {
                    buff.append(",");
                }
                buff.append(array[i][j]);
            }
            buff.append("]");
        }
        buff.append("]");
        String javascript = buff.toString();
        return javascript;
    }

    public void finishError(String errorCode, String origin) {
        System.out.println("ERROR CODE: " + errorCode);
        System.out.println("CAUSE: " + "ARRAY JSON NULL IN " + origin);
        //Redirigir a Facebook

    }

    public boolean isAngelSelect(String[] angels, String idAngel) {
        for (int i = 0; i < angels.length; i++) {
            getLogger().info(getUserSettings().getUid() + ": ANGEL ELEGIDO: " + idAngel);
            getLogger().info(getUserSettings().getUid() + ": ANGEL ACTUAL: " + angels[i]);
            if (angels[i].equals(idAngel)) {
                return true;
            }
        }
        return false;
    }

    public JSONArray loadAngelFile(String[][] angels, String lstAngels, String txtNameAngels) throws JSONException, IOException {
        JSONArray angelsArray = new JSONArray();
        String[] angelsSelec = lstAngels.split(";");

        int cont = 0;

        for (int i = 0; i < angels.length; i++) {
            if (isAngelSelect(angelsSelec, angels[i][0])) {
                getLogger().info(getUserSettings().getUid() + ": ELEGIDO: " + angels[i][0]);
                angelsArray.put(cont, angels[i][1]);
                cont++;
            }
        }

        if (!txtNameAngels.equals("")) {
            angelsArray.put(cont, txtNameAngels);
        }

        return angelsArray;
    }

    public String formatParams(String order, String params) {
        String[] arrayParams = params.split(";");

        String result = order + "(";

        for (int i = 0; i < arrayParams.length; i++) {
            getLogger().info(getUserSettings().getUid() + ": PARAMETRO " + i + ": " + arrayParams[i]);
            result += arrayParams[i] + ',';
            getLogger().info(getUserSettings().getUid() + ": RESULT: " + result);
        }

        if (result.substring(result.length() - 1, result.length()).equals(",")) {
            result = result.substring(0, result.length() - 1) + ");";
        } else if (result.substring(result.length() - 1, result.length()).equals("(")) {
            result += ");";
        }

        return result;
    }

    public String execFbInst(int orden) throws UniformInterfaceException, IOException {
        String resultExec = "";

        for (int j = 0; j < 10; j++) {

            switch (orden) {
                case 1:
                    resultExec = facebookClient.friends_get(String.class, "format=json");
                    break;
                case 2:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "offline_access", "format=json");
                    break;
                case 3:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "read_stream", "format=json");
                    break;
                case 4:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "friends_birthday", "format=json");
                    break;
                case 5:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "offline_access", "format=json");
                    break;
                case 6:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_about_me", "format=json");
                    break;
                case 7:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_relationships", "format=json");
                    break;
                case 8:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_religion_politics", "format=json");
                    break;
                case 9:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_birthday", "format=json");
                    break;
                case 10:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_work_history", "format=json");
                    break;
                case 11:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_education_history", "format=json");
                    break;
                case 12:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_website", "format=json");
                    break;
                case 13:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_hometown", "format=json");
                    break;
                case 14:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_location", "format=json");
                    break;
                case 15:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "user_relationship_details", "format=json");
                    break;
                case 16:
                    resultExec = facebookClient.users_getinfo(String.class, getUserSettings().getUid(), "name,email", "format=json");
                    break;
                case 17:
                    resultExec = facebookClient.users_getinfo(String.class, getUserSettings().getUid(), "sex,religion,relationship_status,political,activities,interests,is_app_user,music,tv,movies,books,about_me,status,quotes", "format=json");
                    break;
                case 18:
                    resultExec = facebookClient.users_getinfo(String.class, getUserSettings().getUid(), "first_name,middle_name,last_name,name,pic_small,pic_big,pic_square,pic,profile_update_time,birthday,birthday_date,significant_other_id,hs_info,notes_count,wall_count,online_presence,locale,proxied_email,profile_url,email_hashes,pic_small_with_logo,pic_big_with_logo,pic_square_with_logo,pic_with_logo,allowed_restrictions,verified,profile_blurb,username,website,is_blocked,contact_email,email,meeting_for,meeting_sex", "format=json");
                    break;
                case 19:
                    resultExec = facebookClient.users_getinfo(String.class, getUserSettings().getUid(), "locale", "format=json");
                    break;
                case 20:
                    resultExec = facebookClient.admin_getAppProperties(String.class, "app_id,publish_action,uninstall_url", "format=json");
                    break;
                case 21:
                    resultExec = facebookClient.fql_query(String.class, "SELECT post_id,viewer_id,app_id,source_id,updated_time,created_time,filter_key,attribution,actor_id,target_id,message,app_data,attachment,type,permalink,xid FROM stream WHERE source_id=" + getUserSettings().getUid() + " LIMIT 1000;", "format=json");
                    break;
                case 22:
                    resultExec = facebookClient.fql_query(String.class, "SELECT post_id,viewer_id,app_id,source_id,updated_time,created_time,filter_key,attribution,actor_id,target_id,message,app_data,attachment,type,permalink,xid FROM stream WHERE source_id=" + getUserSettings().getUid() + " AND updated_time>" + (getUserSettings().getLastCheck().getTime() / 1000) + "", "format=json");
                    break;
                case 23:
                    resultExec = facebookClient.getSessionKeyFacebook();
                    break;
                case 24:
                    resultExec = facebookClient.users_getinfo(String.class, getUserSettings().getUid(), "proxied_email", "format=json");
                    break;
                case 25:
                    resultExec = facebookClient.users_hasAppPermission(String.class, "email", "format=json");
                    break;
            }
            System.out.println("ORDEN: " + resultExec);
            if (!resultExec.contains("error_code") && !resultExec.contains("{}")) {
                break;
            } else if (j == 5) {
                System.out.println("ERROR AL EJECUTAR LA ORDEN: ");
            }
        }
        return resultExec;
    }

    public void sendMailConfirmation() throws JSONException, NoSuchProviderException, MessagingException, UniformInterfaceException, IOException {
        String respuesta = "";
        String respuestaEmail = "";
        String bodyEmail = "";
        JSONObject jsonRespuesta = null;
        JSONObject jsonAngel = null;
        JSONArray jsonArrayAngels = null;
        respuesta = getClient().settingsAngels_getAngelsByUid(String.class, "\"" + this.getUserSettings().getUid() + "\"");
        jsonRespuesta = new JSONObject(respuesta);
        jsonArrayAngels = this.getJSONArray(jsonRespuesta.getString("settingsAngels").toString());

        for (int i = 0; i < jsonArrayAngels.length(); i++) {
            jsonAngel = jsonArrayAngels.getJSONObject(i);

            if (jsonAngel.getString("acceptAngel").equals("0")) {
                if (jsonAngel.getString("typeAngel").equals("F")) {
                    //bodyEmail = this.getBodyMailConfirmationFB(this.getUserSettings().getUidPublic(), jsonAngel.getString("uidAngel"));
                    respuestaEmail = facebookClient.notifications_sendEmail(String.class, jsonAngel.getString("idAngel"),
                            "SNSAngelGuard Notificación: Amigos sospechosos", "text=Hola " + jsonAngel.getString("idAngel") + ",\nAnalizando la lista de amigos de " + jsonAngel.getString("idAngel") + " se han encontrado las siguientes anomalías:\n\n" + jsonAngel.getString("idAngel"));
                    System.out.println("EMAIL ENVIADO A " + respuestaEmail);
                } else {
                    System.out.println("ENVIANDO EMAIL AL USER O: " + jsonAngel.getString("idAngel"));
                    bodyEmail = this.getBodyMailConfirmation(this.getUserSettings().getUidPublic(), jsonAngel.getString("uidAngel"));
                    SNSdataBaseIntegrator.email.setSendTo(jsonAngel.getString("idAngel"));
                    SNSdataBaseIntegrator.email.sendEmail("SNSAngelGuard: Angel Confirmation", bodyEmail);
                    System.out.println("EMAIL ENVIADO");
                }
            }
        }
    }

    public void emailPrueba() throws UniformInterfaceException, IOException {
        System.out.println("ENVIANDO EMAIL PRUEBA");
        String bodyEmail = this.getBodyMailConfirmationFB("0000", "100001105347886");
        String prueba = facebookClient.notifications_sendEmail(String.class, "100001105347886",
                //        "SNSAngelGuard Notificación: Usuario probando aplicacion", "text=Hola José Javier, \n\nEl usuario " +this.getUserSettings().getUserName() + " está probando la aplicación.\n");
                "SNSAngelGuard Notificación: Usuario probando aplicacion", "fbml=" + bodyEmail);

        System.out.println("EMAIL ENVIADO PRUEBA: " + prueba);
    }

    public void sendMailConfirmationAngel(JSONObject jsonAngel, String uidPublic) throws JSONException, UnsupportedEncodingException, UniformInterfaceException, IOException, NoSuchProviderException, MessagingException {
        String respuestaEmail = "";
        String bodyEmail = "";

        if (jsonAngel.getString("typeAngel").equals("F")) {
            bodyEmail = this.getBodyMailConfirmationFB(uidPublic, jsonAngel.getString("uidAngel"));
            respuestaEmail = facebookClient.notifications_sendEmail(String.class, jsonAngel.getString("idAngel"), "SNSAngelGuard: Angel Confirmation", "text=" + "hola");
            System.out.println("EMAIL ENVIADO CONFIRMATION A " + respuestaEmail);
        } else {
            bodyEmail = this.getBodyMailConfirmation(uidPublic, jsonAngel.getString("uidAngel"));
            SNSdataBaseIntegrator.email.setSendTo(jsonAngel.getString("idAngel"));
            SNSdataBaseIntegrator.email.sendEmail("SNSAngelGuard: Angel Confirmation", bodyEmail);
            System.out.println("EMAIL ENVIADO CONFIRMATION");
        }
    }

    public void sendMailDeleteAngel(JSONObject jsonAngel, String uidPublic) throws JSONException, NoSuchProviderException, MessagingException, UniformInterfaceException, IOException {
        String respuestaEmail = "";
        String bodyEmail = "";

        if (jsonAngel.getString("typeAngel").equals("F")) {
            bodyEmail = this.getBodyMailDeleteAngelFB(uidPublic);
            respuestaEmail = facebookClient.notifications_sendEmail(String.class, jsonAngel.getString("idAngel"), "SNSAngelGuard: Angel Deleted", "fbml=" + bodyEmail);
            System.out.println("EMAIL ENVIADO DELETE A " + respuestaEmail);
        } else {
            bodyEmail = this.getBodyMailDeleteAngel(uidPublic);
            SNSdataBaseIntegrator.email.setSendTo(jsonAngel.getString("idAngel"));
            SNSdataBaseIntegrator.email.sendEmail("SNSAngelGuard: Angel Deleted", bodyEmail);
            System.out.println("EMAIL ENVIADO DELETE");
        }
    }

    public String getBodyMailConfirmationFB(String uidPublic, String idAngel) {

        String body = uidPublic + " " + this.getLocaleSettings().getDesInfoAngConfirm()
                + "<fb:tag name=\"a\">"
                + "<fb:tag-attribute name=\"href\">http://www.google.es</fb:tag-attribute>"
                + "<fb:intl>Google</fb:intl>"
                + "</fb:tag-attribute>"
                + "</fb:tag>";
        /*  + "<fb:tabs>"
        + "<fb:tab-item href=\"" + this.getContext() + "SNSAngelGuardFB/angelConfirmation.jsp?par1=" + uidPublic + "&par2=" + idAngel + "&par3=1\" title=" + this.getLocaleSettings().getCancelConfAngConfirm() + " selected='true'/>"
        + "<fb:tab-item href=\"" + this.getContext() + "SNSAngelGuardFB/angelConfirmation.jsp?par1=" + uidPublic + "&par2=" + idAngel + "&par3=0\" title=" + this.getLocaleSettings().getCancelConfAngConfirm() + " selected='true'/>"
        + "</fb:tabs>";*/

        System.out.println("CONTENIDO EMAIL PRUEBA: " + body);
        return body;
    }

    public String getBodyMailConfirmation(String uidPublic, String idAngel) throws UnsupportedEncodingException {

        String body = "<html><head><title>" + this.getLocaleSettings().getTitleAngConfirm() + "</title>"
                + "</head>"
                + "<body><form id=\"frAngelDelete\" action=\"\" method=\"\"><div id=\"divAngelDeleteContainer\" style=\"width: 100%; margin: auto\">"
                + "<table width=\"100%\"><tr><td width=\"60%\"><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:20px;color: #3b5998;margin:5px;\">" + this.getLocaleSettings().getTitleAngConfirm() + "</div></td></tr></table>"
                + "<hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" /><div id=\"divAngelConfirmation\" style=\"margin:10px;height:250px;width: 95%;margin:5px;padding:10px 20px;background:#f7f7f7;border:1px solid #CCC;\"><table id=\"tabInfoConfirmation\">"
                + "<tr><td height=\"20px\"></td></tr><tr><td width=\"10%\" align=\"center\"><img src=\"" + this.getContext() + "SNSAngelGuardFB/resources/icono.gif\" WIDTH=\"83\" HEIGHT=\"111\" alt=\"\">"
                + "</td><td width=\"80%\"><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:15px;color:#333;text-align:justify;padding:10px 10px 10px 10px;\"><A style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;color: #3b5998;cursor:pointer;\" href=\"" + this.getContext() + "SNSAngelGuardFB/angelUser.jsp?par1=" + uidPublic + "\">" + uidPublic + "</A> "
                + this.getLocaleSettings().getDesInfoAngConfirm() + "</div></td><td width=\"10%\" align=\"center\"><img src=\"" + this.getContext() + "SNSAngelGuardFB/resources/icono2.gif\" WIDTH=\"83\" HEIGHT=\"111\" alt=\"\">"
                + "</td></tr><tr><td height=\"20px\"></td></tr></table><center><table id=\"tabLinkConfirmation\"><tr><td height=\"15px\"></td></tr>"
                + "<tr><td height=\"50px\" width=\"50px\" align=\"center\"><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:15px;color:#333;text-align:justify;padding:10px 10px 10px 10px;\">"
                + "<A style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;color: #3b5998;cursor:pointer;\" href=\"" + this.getContext() + "SNSAngelGuardFB/angelConfirmation.jsp?par1=" + uidPublic + "&par2=" + idAngel + "&par3=1\">" + this.getLocaleSettings().getAceptConfAngConfirm() + "</A>"
                + "</div></td><td height=\"50px\" width=\"50px\" align=\"center\">"
                + "<div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:15px;color:#333;text-align:justify;padding:10px 10px 10px 10px;\"><A style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;color: #3b5998;cursor:pointer;\" href=\"" + this.getContext() + "SNSAngelGuardFB/angelConfirmation.jsp?par1=" + uidPublic + "&par2=" + idAngel + "&par3=0\">" + this.getLocaleSettings().getCancelConfAngConfirm() + "</A>"
                + "</div></td></tr><tr><td height=\"15px\"></td></tr></table></center></div><div id=\"botoneraInferior\" style=\"width:100%;\" align=\"left\" margin=\"15px\">"
                + "<hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" /><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:12px;color:#333;text-align:justify;margin: 5px;\"><A style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;color: #3b5998;cursor:pointer;\" href=\"http://www.facebook.com/apps/application.php?id=179105958774916\">SNSAngelGuard</A>" + this.getLocaleSettings().getInfoAngGuard()
                + "</div></div></div></form></body></html>";

        return body;
    }

    public String getBodyMailDeleteAngel(String uidPublic) {
        String menDB[] = this.getLocaleSettings().stringToArray(this.getLocaleSettings().getMailDelete());
        String body = "<html><head><title>" + menDB[0] + "</title>"
                + "</head>"
                + "<body><form id=\"frAngelDelete\" action=\"\" method=\"\"><div id=\"divAngelDeleteContainer\" style=\"width: 100%; margin: auto\">"
                + "<table width=\"100%\"><tr><td width=\"60%\"><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:20px;color: #3b5998;margin:5px;\">" + this.getLocaleSettings().getTitleAngConfirm() + "</div></td></tr></table>"
                + "<hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" /><div id=\"divAngelConfirmation\" style=\"height:250px;width: 95%;padding:10px 20px;background:#f7f7f7;border:1px solid #CCC;margin:10px;\"><table id=\"tabInfoConfirmation\">"
                + "<tr><td height=\"20px\"></td></tr><tr><td width=\"10%\" align=\"center\"><img src=\"" + this.getContext() + "SNSAngelGuardFB/resources/icono.gif\" WIDTH=\"83\" HEIGHT=\"111\" alt=\"\">"
                + "</td><td width=\"80%\"><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:15px;color:#333;text-align:justify;padding:10px 10px 10px 10px;\"><A style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;color: #3b5998;cursor:pointer;\" href=\"" + this.getContext() + "SNSAngelGuardFB/angelUser.jsp?par1=" + uidPublic + "\">" + uidPublic + "</A> "
                + menDB[1] + "</div></td><td width=\"10%\" align=\"center\"><img src=\"" + this.getContext() + "SNSAngelGuardFB/resources/icono2.gif\" WIDTH=\"83\" HEIGHT=\"111\" alt=\"\">"
                + "</td></tr><tr><td height=\"20px\"></td></tr></table></div><div id=\"botoneraInferior\" style=\"width:100%;\" align=\"left\" margin=\"15px\">"
                + "<hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" /><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:12px;color:#333;text-align:justify;margin: 5px;\"><A style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;color: #3b5998;cursor:pointer;\" href=\"http://www.facebook.com/apps/application.php?id=179105958774916\">SNSAngelGuard</A>" + this.getLocaleSettings().getInfoAngGuard()
                + "</div></div></div></form></body></html>";

        return body;
    }

    public String getBodyMailDeleteAngelFB(String uidPublic) {
        String men = " Le ha borrado de su lista de Angeles";
        String body = "<html><head><title>" + "SNSAngelGuard: Aviso" + "</title>"
                + "<style>body{font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:11px;padding:10px;overflow-x:hidden;}"
                + "h1.tituloGr{font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:20px;color: #3b5998;margin:5px;}"
                + "h1.aceptinTerms{font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:15px;color:#333;text-align:justify;padding:10px 10px 10px 10px;}"
                + "h1.infoAngelGuard{font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:12px;color:#333;text-align:justify;margin: 5px;}"
                + "hr.linea{background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;}"
                + "A.link{font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;color: #3b5998;cursor:pointer;}"
                + "div.divAngelConfirmation{height:250px;width: 95%;margin:5px;padding:10px 20px;background:#f7f7f7;border:1px solid #CCC;}"
                + "</style></head>"
                + "<body><form id=\"frAngelDelete\" action=\"\" method=\"\"><div id=\"divAngelDeleteContainer\" style='width: 100%; margin: auto'>"
                + "<table width=\"100%\"><tr><td width=\"60%\"><h1 class=\"tituloGr\">" + this.getLocaleSettings().getTitleAngConfirm() + "</h1></td></tr></table>"
                + "<hr class=\"linea\" /><div id=\"divAngelConfirmation\" class=\"divAngelConfirmation\" style=\"margin:10px;\"><table id=\"tabInfoConfirmation\">"
                + "<tr><td height=\"20px\"></td></tr><tr><td width=\"10%\" align=\"center\"><img src=\"" + this.getContext() + "SNSAngelGuardFB/resources/icono.gif\" WIDTH=\"83\" HEIGHT=\"111\" alt=\"\">"
                + "</td><td width=\"80%\"><h1 class=\"aceptinTerms\"><A class=\"link\" href=\"" + this.getContext() + "SNSAngelGuardFB/angelUser.jsp?par1=" + uidPublic + "\">" + uidPublic + "</A> "
                + men + "</h1></td><td width=\"10%\" align=\"center\"><img src=\"" + this.getContext() + "SNSAngelGuardFB/resources/icono2.gif\" WIDTH=\"83\" HEIGHT=\"111\" alt=\"\">"
                + "</td></tr><tr><td height=\"20px\"></td></tr></table></div><div id=\"botoneraInferior\" style=\"width:100%;\" align=\"left\" margin=\"15px\">"
                + "<hr class=\"linea\" /><h1 class=\"infoAngelGuard\"><A class=\"link\" href=\"http://www.facebook.com/apps/application.php?id=179105958774916\">SNSAngelGuard</A>" + this.getLocaleSettings().getInfoAngGuard()
                + "</h1></div></div></form></body></html>";

        return body;
    }

    public JSONObject getJsonAngel(String idAngel, String uid) throws JSONException {
        String respuesta = "";
        JSONObject jsonRespuesta = null;
        JSONObject jsonAngel = null;
        JSONObject jsonAngelFinal = null;
        JSONArray jsonArrayAngels = null;
        boolean encontrado = false;

        respuesta = getClient().settingsAngels_getAngelsByUid(String.class, "\"" + uid + "\"");
        System.out.println("RESPUESTA GET JSON ANGEL: " + respuesta);
        jsonRespuesta = new JSONObject(respuesta);
        jsonArrayAngels = this.getJSONArray(jsonRespuesta.getString("settingsAngels"));
        System.out.println("idAngel Buscado: " + idAngel);
        for (int i = 0; i < jsonArrayAngels.length(); i++) {
            jsonAngel = jsonArrayAngels.getJSONObject(i);
            System.out.println("ANGEL " + i + ": " + jsonAngel.getString("uidAngel"));
            if (jsonAngel.getString("uidAngel").equals(idAngel)) {
                encontrado = true;
                jsonAngelFinal = jsonAngel;
                break;
            }
        }

        if (!encontrado) {
            jsonAngelFinal = new JSONObject();
        }
        System.out.println("ANGEL OBTENIDO: " + jsonAngelFinal.toString());
        return jsonAngelFinal;
    }

    public void setJsonAngel(JSONObject jsonAngel) throws JSONException {
        String respuesta = "";

        try {
            respuesta = getClient().userSettings_setAngelsCollection(String.class, jsonAngel.getString("uidAngel"), jsonAngel);
        } catch (Exception e) {
            System.out.println("ERROR: " + respuesta);
        }
    }

    public JSONObject getJsonUserByUidPublic(String uidPublic) throws JSONException, UnsupportedEncodingException {
        JSONObject jsonGeneral = null;
        String respuesta = getClient().userSettings_getUserByUidPublic(String.class, "\"" + uidPublic + "\"");
        jsonGeneral = new JSONObject(respuesta);
        return new JSONObject(jsonGeneral.getString("userSettings"));
    }

    public void checkAngelConfirmation(HttpServletRequest request, HttpServletResponse response, JSONObject jsonUser) throws ParseException, JSONException, MySQLIntegrityConstraintViolationException, NoSuchProviderException, FileNotFoundException, MessagingException {
        HttpSession session = request.getSession(false);
        this.loadUserConnected(jsonUser);
        String id = "";

        if (this.getUserSettings().isAppActivated()) {
            try {
                session.setAttribute("facebook_session_key", this.getUserSettings().getUserSession());
                this.getLoginFacebook(request, response);
                for (int i = 0; i < 10; i++) {
                    id = facebookClient.users_getLoggedInUser(String.class, request, "format=json");
                    if (!id.equals("{}") && !id.contains("error_code")) {
                        break;
                    } else if (i == 9) {
                        System.out.println("ERROR AL EJECUTAR LA ORDEN: ");
                    }
                }
                if (!id.equals("{}") && !id.contains("error_code")) {
                    System.out.println("UID OFFLINE: " + id);
                    this.updateLastCheckUS();
                    this.getUserInfo(false);
                }
            } catch (IOException ex) {
                Exceptions.printStackTrace(ex);
            } catch (UniformInterfaceException ex) {
                Exceptions.printStackTrace(ex);
            }
        }
    }

    public String getImgUser(String uid) throws JSONException {
        String respuesta = getClient().userFacebook_getUserFacebookByUid(String.class, uid);
        JSONObject jsonUserFacebook = new JSONObject(respuesta);

        return jsonUserFacebook.getString("picSquare");
    }

    public boolean isActiveFilter(String desFilter) {
        if (desFilter.equals("fltFriends")) {
            return this.getUserSettings().getFltFriends().getActive().equals("1");
        } else if (desFilter.equals("fltWall")) {
            return this.getUserSettings().getFltWall().getActive().equals("1");
        } else if (desFilter.equals("fltPriv")) {
            return this.getUserSettings().getFltPriv().getActive().equals("1");
        } else if (desFilter.equals("fltVist")) {
            return this.getUserSettings().getFltVist().getActive().equals("1");
        } else {
            return false;
        }
    }

    public String checkFilter(HttpServletRequest request, String desFilter, String uidAngel, String mode, boolean firstCheck) throws JSONException, FileNotFoundException, IOException, NoSuchProviderException, MessagingException, ParseException {
        JSONObject jsonFilter = null;
        JSONObject jsonAngels = null;
        JSONObject jsonAngel = null;
        JSONArray jsonArrayAngels = null;
        boolean isAnyAngel = false;
        boolean isActiveFilter = false;
        boolean isTimeToCheck = true;
        String result = "";

        this.getUserSettings().loadFilter(desFilter);

        isActiveFilter = this.isActiveFilter(desFilter);

        if (mode.equals("1")) {
            isTimeToCheck = checkFilterToday(desFilter);
        }

        if (isAnyAngel && isActiveFilter && isTimeToCheck) {
            for (int i = 0; i < jsonArrayAngels.length(); i++) {
                jsonAngel = jsonArrayAngels.getJSONObject(i);
                System.out.println("UID ANGEL JSON: " + jsonAngel.getString("uidAngel") + " IGUAL A UID: " + uidAngel);
                if (jsonAngel.getString("uidAngel").equals(uidAngel)) {
                    System.out.println("ENCONTRADO " + desFilter);
                    result = getResultCheckFilter(request, desFilter, firstCheck, jsonFilter);
                    System.out.println("RESULTADO: " + result);
                }
            }

            jsonFilter.put("lastCheck", "");
            System.out.println("FILTRO " + desFilter + ": " + jsonFilter.toString());
            this.getUserSettings().setAngelsUserSettingsByFilter(desFilter);
        }

        return result;
    }

    public String getResultCheckFilter(HttpServletRequest request, String desFilter, boolean firstCheck, JSONObject jsonFilter) throws FileNotFoundException, IOException, JSONException, NoSuchProviderException, MessagingException, ParseException {

        String result = "";
        System.out.println("DENTRO GET RESULT");
        if (desFilter.equals("fltWall")) {
            result = this.checkPostWall(request, firstCheck, jsonFilter);
        } else if (desFilter.equals("fltFriends")) {
            result = this.checkFriends();
        } else if (desFilter.equals("fltPriv")) {
            result = "Filtro en construccin";
        } else if (desFilter.equals("fltVist")) {
            result = "Filtro en construccin";
        }

        return result;
    }

    public void sendEmailCheck(String resultFltWall, String resultFltFriends, String resultFltPriv, String resultFltVist, JSONObject jsonAngel) throws JSONException, NoSuchProviderException, MessagingException, UniformInterfaceException, IOException {
        System.out.println("DENTRO SEND MAIL CHECK");
        String menDB[] = this.getLocaleSettings().stringToArray(this.getLocaleSettings().getMailNotification());
        String respuestaEmail = "";
        String title = menDB[1];

        String bodyEmail = "<html><head><title>" + menDB[0] + "</title>"
                + "<meta http-equiv=\"Content-Type\" content=\"text/html; charset=ISO-8859-1\" />"
                + "</head><body><form id=\"frAngelNotification\" action=\"\">"
                + "<div id=\"divAngelNotificationContainer\" style=\"position: absolute;width: 95%;margin:15px;\">"
                + "<div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:20px;color: #3b5998;margin:5px;\">" + title + "<A style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;color: #3b5998;cursor:pointer;\" href=\"" + this.getContext() + "SNSAngelGuardFB/angelUser.jsp?par1=" + this.getUserSettings().getUidPublic() + "\">" + this.getUserSettings().getUidPublic() + "</A>"
                + "<hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" />"
                + "<table width=\"97%\">";

        if (!resultFltWall.equals("")) {
            System.out.println("INFORME: " + resultFltWall);
            bodyEmail += "<tr><td width=\"95%\"><br><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:15px;color: #3b5998;margin:5px;\">Filter Wall</div><hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" /></td></tr>"
                    + "<tr><td><div id=\"divFilterWall\" style=\"height: auto;margin:10px;width:90%;margin:10px;padding:10px 20px;background:#f7f7f7;border:1px solid #CCC;\"><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:12px;text-align:justify;color:#808080;padding:10px 10px 10px;\">" + resultFltWall + "</div>"
                    + "</div></td></tr>";
        }

        if (!resultFltFriends.equals("")) {
            System.out.println("INFORME: " + resultFltFriends);
            bodyEmail += "<tr><td width=\"95%\"><br><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:15px;color: #3b5998;margin:5px;\">Filter Friends</div><hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" /></td></tr>"
                    + "<tr><td><div id=\"divFilterFriends\" style=\"height: auto;margin:10px;width:90%;margin:10px;padding:10px 20px;background:#f7f7f7;border:1px solid #CCC;\"><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:12px;text-align:justify;color:#808080;padding:10px 10px 10px;\">" + resultFltFriends + "</div>"
                    + "</div></td></tr>";
        }
        if (!resultFltPriv.equals("")) {
            System.out.println("INFORME: " + resultFltPriv);
            bodyEmail += "<tr><td width=\"95%\"><br><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:15px;color: #3b5998;margin:5px;\">Filter Privacity</div><hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" /></td></tr>"
                    + "<tr><td><div id=\"divFilterPriv\" style=\"height: auto;margin:10px;width:90%;margin:10px;padding:10px 20px;background:#f7f7f7;border:1px solid #CCC;\"><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:12px;text-align:justify;color:#808080;padding:10px 10px 10px;\">" + resultFltPriv + "</div>"
                    + "</div></td></tr>";
        }
        if (!resultFltVist.equals("")) {
            System.out.println("INFORME: " + resultFltVist);
            bodyEmail += "<tr><td width=\"95%\"><br><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:15px;color: #3b5998;margin:5px;\">Filter Visits</div><hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" /></td></tr>"
                    + "<tr><td><div id=\"divFilterVist\" style=\"height: auto;margin:10px;width:90%;margin:10px;padding:10px 20px;background:#f7f7f7;border:1px solid #CCC;\"><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:12px;text-align:justify;color:#808080;padding:10px 10px 10px;\">" + resultFltVist + "</div>"
                    + "</div></td></tr>";
        }

        bodyEmail += "</table><div id=\"botoneraInferior\" style=\"width:100%;\" align=\"left\" margin=\"15px\">"
                + "<hr style=\"background:#d9d9d9;border-width:0;color:#d9d9d9;height:1px;margin:2px;\" /><div style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;font-size:12px;color:#333;text-align:justify;margin: 5px;\"><A style=\"font-family:\"lucida grande\",tahoma,verdana,arial,sans-serif;color: #3b5998;cursor:pointer;\" href=\"http://www.facebook.com/apps/application.php?id=179105958774916\">SNSAngelGuard</A>" + this.getLocaleSettings().getInfoAngGuard()
                + "</div></div></div></form></body></html>";

        System.out.println("BODY MAIL SEND MAIL CHECK: " + bodyEmail);
        if (jsonAngel.getString("typeAngel").equals("F")) {
            respuestaEmail = facebookClient.notifications_sendEmail(String.class, jsonAngel.getString("idAngel"), "SNSAngelGuard: Angel Notification", "text=" + bodyEmail, "fbml=" + bodyEmail);
            System.out.println("EMAIL ENVIADO A " + respuestaEmail);
        } else {
            System.out.println("ENVIANDO EMAIL AL USER O: " + jsonAngel.getString("idAngel"));
            SNSdataBaseIntegrator.email.setSendTo(jsonAngel.getString("idAngel"));
            SNSdataBaseIntegrator.email.sendEmail(menDB[0], bodyEmail);
            System.out.println("EMAIL ENVIADO");
        }
        System.out.println("DENTRO SEND MAIL CHECK");
    }

    public void firstCheckAngelConfirmation(HttpServletRequest request, JSONObject jsonAngel) throws JSONException, FileNotFoundException, IOException, NoSuchProviderException, MessagingException, ParseException {
        System.out.println("DENTRO FIRST CHECK");
        String resultFltWall = this.checkFilter(request, "fltWall", jsonAngel.getString("uidAngel"), "0", true);
        System.out.println("RESULT WALL: " + resultFltWall);
        String resultFltFriends = this.checkFilter(request, "fltFriends", jsonAngel.getString("uidAngel"), "0", true);
        System.out.println("RESULT FRIENDS: " + resultFltWall);
        String resultFltPriv = this.checkFilter(request, "fltPriv", jsonAngel.getString("uidAngel"), "0", true);
        System.out.println("RESULT PRIV: " + resultFltPriv);
        String resultFltVist = this.checkFilter(request, "fltVist", jsonAngel.getString("uidAngel"), "0", true);
        System.out.println("RESULT VIST: " + resultFltVist);

        this.sendEmailCheck(resultFltWall, resultFltFriends, resultFltPriv, resultFltVist, jsonAngel);
        System.out.println("FUERA FIRST CHECK");
    }

    public void checkUserSettingsOffLine(HttpServletRequest request, JSONObject jsonAngel) throws JSONException, FileNotFoundException, IOException, NoSuchProviderException, MessagingException, ParseException {
        System.out.println("DENTRO CHECK OFFLINE");
        String resultFltWall = this.checkFilter(request, "fltWall", jsonAngel.getString("uidAngel"), "1", false);
        System.out.println("RESULT WALL OFFLINE: " + resultFltWall);
        String resultFltFriends = this.checkFilter(request, "fltFriends", jsonAngel.getString("uidAngel"), "1", false);
        System.out.println("RESULT FRIENDS OFFLINE: " + resultFltWall);
        String resultFltPriv = this.checkFilter(request, "fltPriv", jsonAngel.getString("uidAngel"), "1", false);
        System.out.println("RESULT PRIV OFFLINE: " + resultFltPriv);
        String resultFltVist = this.checkFilter(request, "fltVist", jsonAngel.getString("uidAngel"), "1", false);
        System.out.println("RESULT VIST OFFLINE: " + resultFltVist);

        this.sendEmailCheck(resultFltWall, resultFltFriends, resultFltPriv, resultFltVist, jsonAngel);
        System.out.println("FUERA CHECK OFFLINE");
    }
}
